<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Zev - Cloud Diary</title>
    <!-- Favicon / Webpage Logo -->
    <link rel="icon" type="image/png" href="zz1.png">
    <link rel="apple-touch-icon" href="zz1.png">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    colors: {
                        gray: {
                            50: '#F9FAFB', 100: '#F3F4F6', 200: '#E5E7EB', 300: '#D1D5DB',
                            400: '#9CA3AF', 500: '#6B7280', 600: '#4B5563', 700: '#374151',
                            800: '#1F2937', 900: '#111827',
                        }
                    },
                    padding: {
                        'safe-top': 'env(safe-area-inset-top)',
                        'safe-bottom': 'env(safe-area-inset-bottom)',
                    }
                }
            }
        }
    </script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .scrollbar-hover::-webkit-scrollbar { width: 4px; height: 4px; }
        .scrollbar-hover::-webkit-scrollbar-track { background: transparent; }
        .scrollbar-hover::-webkit-scrollbar-thumb { background-color: transparent; border-radius: 4px; transition: background-color 0.2s; }
        .group:hover .scrollbar-hover::-webkit-scrollbar-thumb { background-color: rgba(156, 163, 175, 0.4); }
        .scrollbar-thin::-webkit-scrollbar { width: 4px; height: 4px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: transparent; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background-color: rgba(156, 163, 175, 0.3); border-radius: 4px; }
        *:focus { outline: none; }
        /* Silky smooth transitions */
        .transition-silky { transition: all 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-4px); }
            20%, 40%, 60%, 80% { transform: translateX(4px); }
        }
        .animate-shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        
        /* Editor Images Style */
        .rich-editor img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 10px 0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            display: inline-block;
        }
        .rich-editor:empty:before {
            content: attr(placeholder);
            color: #9ca3af;
            pointer-events: none;
        }
        
        /* Specific styles for images inside the mini calendar cells to prevent layout breaking */
        .mini-cell-content img {
            max-width: 100%;
            height: auto;
            opacity: 0.8;
            border-radius: 4px;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 antialiased overflow-hidden transition-colors duration-300">
    <div id="root"></div>

    <script type="importmap">
        {
            "imports": {
                "react": "https://esm.sh/react@18.3.1?dev",
                "react-dom/client": "https://esm.sh/react-dom@18.3.1/client?dev",
                "lucide-react": "https://esm.sh/lucide-react@0.263.1?external=react,react-dom",
                "date-fns": "https://esm.sh/date-fns@2.30.0",
                "date-fns/locale": "https://esm.sh/date-fns@2.30.0/locale",
                "framer-motion": "https://esm.sh/framer-motion@10.16.4?external=react,react-dom"
            }
        }
    </script>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            ChevronLeft, ChevronRight, ChevronDown, Calendar as CalendarIcon, FileText, 
            Moon, Sun, Eye, EyeOff, Download, Maximize2, Clock, Plus, Trash2, Edit2, 
            Check, X, Lock, Unlock, Archive, Search, Settings, HelpCircle, Bell, Menu, Upload, 
            FolderOpen, Save, HardDrive, FileJson, RefreshCw, Link as LinkIcon, Palette,
            Cloud, Wifi, WifiOff, Copy, LogOut, FileDown, FileUp, LayoutGrid, Rows,
            Smartphone, Monitor, ArrowRight, Shield, ShieldAlert, CheckSquare, Circle, CheckCircle,
            Image as ImageIcon, GripVertical
        } from 'lucide-react';
        import { 
            format, addMonths, subMonths, startOfMonth, endOfMonth, 
            startOfWeek, endOfWeek, eachDayOfInterval, isSameMonth, isSameDay,
            addDays, subDays, isToday, setMonth, setYear, getYear, getMonth, parseISO,
            addWeeks, subWeeks, addYears, subYears
        } from 'date-fns';
        import { enUS } from 'date-fns/locale';
        import { motion, AnimatePresence, Reorder, useDragControls } from 'framer-motion';

        // --- GitHub API Helper ---
        const GIST_FILENAME = "zev_diary_data.json";
        
        const getGist = async (token, gistId) => {
            const res = await fetch(`https://api.github.com/gists/${gistId}`, {
                headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json' }
            });
            if (!res.ok) throw new Error('Failed to fetch Gist');
            const data = await res.json();
            const content = data.files[GIST_FILENAME]?.content;
            return content ? JSON.parse(content) : null;
        };

        const createGist = async (token, content) => {
            const res = await fetch('https://api.github.com/gists', {
                method: 'POST',
                headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json' },
                body: JSON.stringify({
                    description: "Zev Diary Sync Data",
                    public: false,
                    files: { [GIST_FILENAME]: { content: JSON.stringify(content, null, 2) } }
                })
            });
            if (!res.ok) throw new Error('Failed to create Gist');
            return await res.json();
        };

        const updateGist = async (token, gistId, content) => {
            const res = await fetch(`https://api.github.com/gists/${gistId}`, {
                method: 'PATCH',
                headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json' },
                body: JSON.stringify({
                    files: { [GIST_FILENAME]: { content: JSON.stringify(content, null, 2) } }
                })
            });
            if (!res.ok) throw new Error('Failed to update Gist');
            return await res.json();
        };

        // --- Helper: Strip HTML for Preview ---
        const stripHtml = (html) => {
            if (!html) return '';
            // 将 <img> 标签替换为 [图片]
            let text = html.replace(/<img[^>]*>/g, ' [图片] ');
            // 替换换行标签为空格
            text = text.replace(/<br\s*\/?>/gi, ' ');
            text = text.replace(/<\/div>/gi, ' ');
            text = text.replace(/<\/p>/gi, ' ');
            // 创建临时 DOM 元素去除其他标签
            const doc = new DOMParser().parseFromString(text, 'text/html');
            return doc.body.textContent || "";
        };

        // --- Constants ---
        const THEMES = {
            light: {
                name: 'Light', bg: 'bg-white', sidebar: 'bg-gray-50 border-r border-gray-200', sidebarText: 'text-gray-500', sidebarActive: 'bg-gray-100', 
                header: 'bg-white', card: 'bg-white', text: 'text-gray-900', subText: 'text-gray-500', border: 'border-gray-200',
                dayBg: 'bg-white', dayHover: 'hover:bg-gray-50', lockBg: 'bg-gray-50',
            },
            dark: {
                name: 'Dark', bg: 'bg-gray-900', sidebar: 'bg-gray-800 border-r border-gray-700', sidebarText: 'text-gray-400', sidebarActive: 'bg-gray-700 text-white',
                header: 'bg-gray-900', card: 'bg-gray-800', text: 'text-gray-100', subText: 'text-gray-500', border: 'border-gray-700',
                dayBg: 'bg-gray-900', dayHover: 'hover:bg-gray-800', lockBg: 'bg-gray-950',
            },
            eyeCare: {
                name: 'Eye Care', bg: 'bg-[#f5f1e6]', sidebar: 'bg-[#e8e4d9] border-r border-[#dcd7cb]', sidebarText: 'text-[#5c5548]', sidebarActive: 'bg-[#dcd7cb] text-[#3e3931]',
                header: 'bg-[#f5f1e6]', card: 'bg-[#fdfbf7]', text: 'text-[#3e3931]', subText: 'text-[#968e81]', border: 'border-[#dcd7cb]',
                dayBg: 'bg-[#fdfbf7]', dayHover: 'hover:bg-[#f5f1e6]', lockBg: 'bg-[#e8e4d9]',
            }
        };

        const CALENDAR_COLORS = [
            { name: 'Ink', value: 'text-gray-900 dark:text-gray-100', code: '#111827' },
            { name: 'Red', value: 'text-red-600 dark:text-red-400', code: '#dc2626' },
            { name: 'Orange', value: 'text-orange-600 dark:text-orange-400', code: '#ea580c' },
            { name: 'Green', value: 'text-emerald-600 dark:text-emerald-400', code: '#059669' },
            { name: 'Blue', value: 'text-blue-600 dark:text-blue-400', code: '#2563eb' },
            { name: 'Purple', value: 'text-purple-600 dark:text-purple-400', code: '#9333ea' },
            { name: 'Pink', value: 'text-pink-600 dark:text-pink-400', code: '#db2777' },
        ];
        
        const ENTRY_BG_COLORS = [
            { name: 'Default', class: 'bg-white dark:bg-gray-800/50', code: '#ffffff' }, 
            { name: 'Warm Red', class: 'bg-red-50 dark:bg-red-900/20', code: '#fef2f2' },
            { name: 'Orange', class: 'bg-orange-50 dark:bg-orange-900/20', code: '#fff7ed' },
            { name: 'Amber', class: 'bg-amber-50 dark:bg-amber-900/20', code: '#fffbeb' },
            { name: 'Green', class: 'bg-emerald-50 dark:bg-emerald-900/20', code: '#ecfdf5' },
            { name: 'Teal', class: 'bg-teal-50 dark:bg-teal-900/20', code: '#f0fdfa' },
            { name: 'Blue', class: 'bg-blue-50 dark:bg-blue-900/20', code: '#eff6ff' },
            { name: 'Indigo', class: 'bg-indigo-50 dark:bg-indigo-900/20', code: '#eef2ff' },
            { name: 'Purple', class: 'bg-purple-50 dark:bg-purple-900/20', code: '#faf5ff' },
            { name: 'Rose', class: 'bg-rose-50 dark:bg-rose-900/20', code: '#fff1f2' },
        ];

        const PAGE_TRANSITION = { type: "tween", ease: "circOut", duration: 0.25 };
        const generateId = () => Math.random().toString(36).substr(2, 9);

        // --- Camouflaged Lock Screen ---
        function LockScreen({ onUnlock, theme }) {
            const [password, setPassword] = useState('');
            const [shake, setShake] = useState(false);
            
            const handleUnlock = (e) => { 
                if(e) e.stopPropagation(); 
                if(e) e.preventDefault();
                onUnlock(); 
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                setShake(true);
                setPassword(''); 
                setTimeout(() => setShake(false), 400);
            }

            useEffect(() => {
                const handleKeyDown = (e) => { if (e.key === 'Escape') onUnlock(); };
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [onUnlock]);
            
            return (
                <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }} className={`fixed inset-0 z-50 flex items-center justify-center ${theme.lockBg} ${theme.text}`}>
                    <div className={`flex flex-col items-center gap-8 p-12 rounded-3xl w-full max-w-sm ${shake ? 'animate-shake' : ''}`}>
                        <div 
                            onClick={handleUnlock}
                            className={`w-28 h-28 rounded-full flex items-center justify-center shadow-2xl mb-2 bg-gradient-to-br from-gray-100 to-gray-200 dark:from-gray-800 dark:to-gray-900 border-4 border-white dark:border-gray-700 cursor-pointer active:scale-95 transition-transform group overflow-hidden`}
                            title="Secured"
                        >
                            {/* Replaced generic lock with user logo */}
                            <img src="zz1.png" alt="Logo" className="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity" onError={(e) => { e.target.style.display = 'none'; e.target.nextSibling.style.display = 'block'; }} />
                            <Lock size={40} className="hidden text-gray-400 dark:text-gray-500 group-hover:text-gray-600 dark:group-hover:text-gray-300 transition-colors" />
                        </div>
                        
                        <div className="w-full space-y-4">
                            <div className="text-center">
                                <h1 className="text-xl font-medium tracking-wide opacity-80">Zev Diary</h1>
                                <p className="text-xs opacity-40 mt-1 uppercase tracking-widest">Locked</p>
                            </div>
                            
                            <form onSubmit={handleSubmit} className="relative w-full">
                                <input 
                                    type="password" 
                                    value={password} 
                                    onChange={(e) => setPassword(e.target.value)} 
                                    placeholder="Password"
                                    className={`w-full h-12 pl-4 pr-12 rounded-xl border ${theme.border} bg-white/50 dark:bg-black/20 outline-none focus:ring-2 focus:ring-gray-200 dark:focus:ring-gray-700 transition-all text-sm text-gray-900 dark:text-gray-100`}
                                    autoFocus
                                />
                                <button 
                                    type="submit"
                                    className="absolute right-2 top-2 h-8 w-8 flex items-center justify-center rounded-lg bg-gray-200 dark:bg-gray-700 text-gray-500 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors"
                                    title="Unlock"
                                >
                                    <ArrowRight size={16} />
                                </button>
                            </form>
                        </div>
                    </div>
                </motion.div>
            );
        }

        // --- Cloud Settings Modal ---
        function CloudSettingsModal({ isOpen, onClose, config, onConnectSuccess, onDisconnect, theme }) {
            const [token, setToken] = useState(config.token || '');
            const [gistId, setGistId] = useState(config.gistId || '');
            const [isLoading, setIsLoading] = useState(false);
            const [error, setError] = useState('');
            useEffect(() => { setToken(config.token || ''); setGistId(config.gistId || ''); }, [config, isOpen]);
            const handleConnect = async (isNew) => {
                if (!token) return setError('Token is required');
                setIsLoading(true); setError('');
                try {
                    let id = gistId;
                    let data = null;
                    if (isNew) {
                        const newGist = await createGist(token, { calendars: [], entries: {}, entryColors: {}, themeMode: 'light' });
                        id = newGist.id;
                    } else {
                        if (!id) return setError('Gist ID is required for existing connection');
                        data = await getGist(token, id);
                        if (!data) throw new Error("Could not retrieve data from Gist");
                    }
                    onConnectSuccess(token, id, data); onClose();
                } catch (e) { setError(e.message); } finally { setIsLoading(false); }
            };
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/20 backdrop-blur-sm p-4 animate-in fade-in zoom-in-95 duration-200">
                    <div className={`w-full max-w-md p-6 rounded-2xl shadow-2xl ${theme.card} ${theme.text} border ${theme.border}`}>
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-lg font-semibold flex items-center gap-2"><Cloud size={20}/> Cloud Sync</h2>
                            <button onClick={onClose}><X size={18} className={theme.subText}/></button>
                        </div>
                        {config.token && config.gistId ? (
                            <div className="space-y-4">
                                <div className={`p-4 rounded-lg bg-green-50 border border-green-100 text-green-800 text-sm`}><div className="flex items-center gap-2 font-medium mb-1"><Wifi size={16}/> Connected</div><p className="opacity-80">Your diary is syncing to GitHub Gist.</p></div>
                                <div className="flex gap-2"><code className="flex-1 p-2 bg-gray-100 rounded text-xs truncate">{config.gistId}</code><button onClick={() => navigator.clipboard.writeText(config.gistId)} className="p-2 hover:bg-gray-200 rounded"><Copy size={14}/></button></div>
                                <button onClick={onDisconnect} className="w-full py-2.5 rounded-lg border border-red-200 text-red-600 hover:bg-red-50 text-sm font-medium mt-4">Disconnect</button>
                            </div>
                        ) : (
                            <div className="space-y-4">
                                <input type="password" value={token} onChange={e=>setToken(e.target.value)} placeholder="GitHub Personal Token (ghp_...)" className={`w-full p-2.5 rounded-lg border ${theme.border} bg-transparent text-sm focus:ring-2 focus:ring-gray-200 ${theme.text}`} />
                                <div className="grid grid-cols-2 gap-3 pt-2">
                                    <button onClick={() => handleConnect(true)} disabled={isLoading} className="flex flex-col items-center justify-center gap-2 p-4 rounded-xl border border-gray-200 hover:border-gray-400 hover:bg-gray-50 transition-all"><Plus size={20} className="opacity-50"/><span className="text-sm font-medium">New Gist</span></button>
                                    <button onClick={() => { if(!gistId) { setError('Enter Gist ID'); return; } handleConnect(false); }} disabled={isLoading} className="flex flex-col items-center justify-center gap-2 p-4 rounded-xl border border-gray-200 hover:border-gray-400 hover:bg-gray-50 transition-all"><Download size={20} className="opacity-50"/><span className="text-sm font-medium">Load Existing</span></button>
                                </div>
                                <input value={gistId} onChange={e=>setGistId(e.target.value)} placeholder="Or Existing Gist ID" className={`w-full p-2.5 rounded-lg border ${theme.border} bg-transparent text-sm focus:ring-2 focus:ring-gray-200 ${theme.text}`} />
                                {error && <p className="text-xs text-red-500">{error}</p>}
                                {isLoading && <p className="text-xs text-center opacity-50">Connecting...</p>}
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // --- Main App ---
        function App() {
            const [isMobileMode, setIsMobileMode] = useState(window.innerWidth < 768);
            const [calendars, setCalendars] = useState([{ id: 'default', name: 'My Diary', colorIndex: 4 }]);
            const [entries, setEntries] = useState({ 'default': {} });
            const [todos, setTodos] = useState({}); // New State for Todos
            const [entryColors, setEntryColors] = useState({});
            const [activeCalendarId, setActiveCalendarId] = useState('default');
            const [visibleCalendarIds, setVisibleCalendarIds] = useState(new Set(['default']));
            
            const [currentDate, setCurrentDate] = useState(new Date());
            const [selectedDate, setSelectedDate] = useState(new Date());
            // Added 'todo' to views
            // Modified: Default to 'day' (Focus Mode) on all devices as requested
            const [view, setView] = useState('day');
            const [themeMode, setThemeMode] = useState('light');
            const [isSidebarOpen, setIsSidebarOpen] = useState(window.innerWidth >= 768);
            const [isDatePickerOpen, setIsDatePickerOpen] = useState(false);
            const [isLocked, setIsLocked] = useState(true);
            const [searchQuery, setSearchQuery] = useState('');
            const [isCloudModalOpen, setIsCloudModalOpen] = useState(false);
            const [autoLockDisabled, setAutoLockDisabled] = useState(false); 
            
            // --- CRITICAL FIX: Data Load Safety Flag ---
            const [isDataLoaded, setIsDataLoaded] = useState(false);

            const [githubConfig, setGithubConfig] = useState({ token: '', gistId: '' });
            const [saveStatus, setSaveStatus] = useState('idle');
            const [lastSaved, setLastSaved] = useState(null);
            
            const theme = THEMES[themeMode];
            const searchInputRef = useRef(null);
            const importInputRef = useRef(null);
            const saveTimeoutRef = useRef(null);
            const activityTimerRef = useRef(null);

            useEffect(() => {
                const load = async () => {
                    const savedTheme = localStorage.getItem('diary_theme');
                    if (savedTheme && THEMES[savedTheme]) setThemeMode(savedTheme);
                    const savedGithub = localStorage.getItem('diary_github_config');
                    let ghConfig = null;
                    if (savedGithub) { ghConfig = JSON.parse(savedGithub); setGithubConfig(ghConfig); }
                    if (ghConfig && ghConfig.token && ghConfig.gistId) {
                        try {
                            setSaveStatus('saving');
                            const data = await getGist(ghConfig.token, ghConfig.gistId);
                            if (data) {
                                applyData(data);
                                setIsDataLoaded(true); // MARK AS LOADED ONLY ON SUCCESS
                                setSaveStatus('saved');
                            } else {
                                throw new Error("Empty data received");
                            }
                        } catch (e) { 
                            setSaveStatus('error'); 
                            console.error("Critical: Initial load failed. Auto-save disabled to prevent data loss.", e);
                            // Do NOT set isDataLoaded(true) here. This is the safety breaker.
                        }
                    } else {
                        try {
                            const lsEntries = localStorage.getItem('diary_entries');
                            if (lsEntries) setEntries(JSON.parse(lsEntries));
                            
                            // --- Fix: Restore lost Todos (Migration Logic) ---
                            const lsTodos = localStorage.getItem('diary_todos');
                            if (lsTodos) {
                                const parsed = JSON.parse(lsTodos);
                                if (Array.isArray(parsed)) {
                                    setTodos({ 'default': parsed });
                                } else {
                                    setTodos(parsed);
                                }
                            }
                            
                            const lsCals = localStorage.getItem('diary_calendars');
                            if (lsCals) setCalendars(JSON.parse(lsCals));
                            const lsColors = localStorage.getItem('diary_entry_colors');
                            if (lsColors) setEntryColors(JSON.parse(lsColors));
                            
                            setIsDataLoaded(true); // Local load is considered safe/complete
                        } catch (e) {
                            console.error("Local load error", e);
                            setIsDataLoaded(true); // Fallback to new empty state if local parse fails
                        }
                    }
                };
                load();
            }, []);

            useEffect(() => {
                // --- SAFETY BREAKER: Prevent saving if data wasn't loaded successfully ---
                if (!isDataLoaded) return;

                localStorage.setItem('diary_entries', JSON.stringify(entries));
                localStorage.setItem('diary_todos', JSON.stringify(todos));
                localStorage.setItem('diary_entry_colors', JSON.stringify(entryColors));
                localStorage.setItem('diary_calendars', JSON.stringify(calendars));
                localStorage.setItem('diary_theme', themeMode);
                if (saveTimeoutRef.current) clearTimeout(saveTimeoutRef.current);
                if (githubConfig.token) {
                    setSaveStatus('saving');
                    saveTimeoutRef.current = setTimeout(async () => {
                        const data = { calendars, entries, todos, entryColors, themeMode }; // Save todos
                        try {
                            if (githubConfig.token && githubConfig.gistId) await updateGist(githubConfig.token, githubConfig.gistId, data);
                            setLastSaved(new Date()); setSaveStatus('saved');
                        } catch (err) { setSaveStatus('error'); }
                    }, 2000);
                }
            }, [entries, todos, entryColors, calendars, themeMode, githubConfig, isDataLoaded]);

            const applyData = (data) => {
                if(!data) return;
                if (data.calendars) setCalendars(data.calendars);
                if (data.entries) setEntries(data.entries);
                
                // --- Fix: Restore cloud Todos (Migration Logic) ---
                if (data.todos) {
                    if (Array.isArray(data.todos)) {
                        setTodos({ 'default': data.todos });
                    } else {
                        setTodos(data.todos);
                    }
                }
                
                if (data.entryColors) setEntryColors(data.entryColors);
                if (data.themeMode) setThemeMode(data.themeMode);
                if (data.calendars && data.calendars.length > 0) { setActiveCalendarId(data.calendars[0].id); setVisibleCalendarIds(new Set([data.calendars[0].id])); }
            };

            const resetActivityTimer = () => {
                if (activityTimerRef.current) clearTimeout(activityTimerRef.current);
                if (!autoLockDisabled) {
                    activityTimerRef.current = setTimeout(() => { setIsLocked(true); }, 15 * 60 * 1000);
                }
            };
            useEffect(() => {
                const events = ['mousedown', 'keydown', 'touchstart', 'scroll'];
                const handler = () => { if (!isLocked) resetActivityTimer(); };
                events.forEach(e => window.addEventListener(e, handler));
                return () => { events.forEach(e => window.removeEventListener(e, handler)); };
            }, [isLocked, autoLockDisabled]);

            useEffect(() => {
                const handleKeyDown = (e) => {
                    if (e.key === 'Escape' && view === 'day') {
                        setView(isMobileMode ? 'week' : 'month');
                    }
                };
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [view, isMobileMode]);

            const handleEntryChange = (dateStr, text) => setEntries(prev => ({ ...prev, [activeCalendarId]: { ...(prev[activeCalendarId] || {}), [dateStr]: text } }));
            const handleColorChange = (dateStr, colorIndex) => setEntryColors(prev => ({ ...prev, [activeCalendarId]: { ...(prev[activeCalendarId] || {}), [dateStr]: colorIndex } }));
            
            // Todo Handlers
            const handleTodoAdd = (text) => {
                const newTodo = { id: generateId(), text, completed: false, createdAt: new Date().toISOString() };
                setTodos(prev => ({
                    ...prev,
                    [activeCalendarId]: [...(prev[activeCalendarId] || []), newTodo]
                }));
            };
            const handleTodoToggle = (id) => {
                setTodos(prev => ({
                    ...prev,
                    [activeCalendarId]: prev[activeCalendarId].map(t => t.id === id ? { ...t, completed: !t.completed } : t)
                }));
            };
            const handleTodoDelete = (id) => {
                setTodos(prev => ({
                    ...prev,
                    [activeCalendarId]: prev[activeCalendarId].filter(t => t.id !== id)
                }));
            };
            
            // New Handler for Todo Edit
            const handleTodoEdit = (id, newText) => {
                setTodos(prev => ({
                    ...prev,
                    [activeCalendarId]: prev[activeCalendarId].map(t => t.id === id ? { ...t, text: newText } : t)
                }));
            };

            // New Handler for Reordering
            const handleTodoReorder = (newOrder) => {
                setTodos(prev => ({
                    ...prev,
                    [activeCalendarId]: newOrder
                }));
            };

            const handleConnectSuccess = (token, gistId, data) => {
                if(data) applyData(data);
                const config = { token, gistId };
                setGithubConfig(config);
                localStorage.setItem('diary_github_config', JSON.stringify(config));
                setSaveStatus('saved');
            };

            const handleCloudDisconnect = () => {
                if(confirm("Disconnect cloud sync?")) {
                    setGithubConfig({ token: '', gistId: '' });
                    localStorage.removeItem('diary_github_config');
                    setIsCloudModalOpen(false);
                }
            };

            const handleExportBackup = () => {
                const data = { calendars, entries, todos, entryColors, themeMode };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = `zev_diary_backup_${format(new Date(), 'yyyy-MM-dd')}.json`;
                document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
            };

            const handleImportBackup = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (confirm("Restore backup?")) { applyData(data); alert("Success!"); }
                    } catch (err) { alert("Failed to parse file."); }
                };
                reader.readAsText(file);
                event.target.value = null; 
            };

            const handleNavigate = (direction) => {
                if (view === 'month') setCurrentDate(prev => direction === 'prev' ? subMonths(prev, 1) : addMonths(prev, 1));
                else if (view === 'week') setCurrentDate(prev => direction === 'prev' ? subWeeks(prev, 1) : addWeeks(prev, 1));
                else setSelectedDate(prev => {
                    const newDate = direction === 'prev' ? subDays(prev, 1) : addDays(prev, 1);
                    if (!isSameMonth(newDate, currentDate)) setCurrentDate(newDate);
                    return newDate;
                });
            };

            const toggleLayoutMode = () => {
                const newMode = !isMobileMode;
                setIsMobileMode(newMode);
                if (newMode) { setIsSidebarOpen(false); setView('week'); } else { setIsSidebarOpen(true); setView('month'); }
            };
            
            const getEntry = (date) => entries[activeCalendarId]?.[format(date, 'yyyy-MM-dd')] || '';

            // Calculate pending todos for sidebar badge
            const pendingTodoCount = (todos[activeCalendarId] || []).filter(t => !t.completed).length;

            return (
                <div className={`flex h-screen w-full overflow-hidden ${theme.bg} ${theme.text} ${themeMode === 'dark' ? 'dark' : ''}`}>
                    <AnimatePresence>
                        {isLocked && <LockScreen key="lock" onUnlock={() => setIsLocked(false)} theme={theme} />}
                    </AnimatePresence>
                    
                    <CloudSettingsModal isOpen={isCloudModalOpen} onClose={() => setIsCloudModalOpen(false)} config={githubConfig} onConnectSuccess={handleConnectSuccess} onDisconnect={handleCloudDisconnect} theme={theme} />
                    <input type="file" ref={importInputRef} style={{display:'none'}} accept=".json" onChange={handleImportBackup} />

                    <AnimatePresence>
                        {isMobileMode && isSidebarOpen && (
                            <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }} className="fixed inset-0 bg-black/50 z-30 backdrop-blur-sm" onClick={() => setIsSidebarOpen(false)} />
                        )}
                    </AnimatePresence>

                    <motion.div animate={{ width: isSidebarOpen ? 260 : 0, x: isSidebarOpen ? 0 : (isMobileMode ? -260 : 0), opacity: (isSidebarOpen || isMobileMode) ? 1 : 0 }} className={`flex-shrink-0 flex flex-col ${theme.sidebar} h-full z-40 pt-safe-top overflow-hidden ${isMobileMode ? 'fixed top-0 left-0 shadow-2xl' : 'relative'} ${!isSidebarOpen && !isMobileMode ? 'pointer-events-none' : ''}`}>
                        <div className="p-5 flex flex-col h-full pt-6 w-[260px]">
                            {isMobileMode && <button onClick={() => setIsSidebarOpen(false)} className="absolute top-4 right-4 p-2 text-gray-400"><X size={20}/></button>}
                            <div className="space-y-1 flex-1 overflow-y-auto scrollbar-thin mt-8 md:mt-0">
                                <SidebarItem icon={<LayoutGrid size={18} />} label="Month View" active={view==='month'} theme={theme} onClick={() => { setView('month'); if(isMobileMode) setIsSidebarOpen(false); }} />
                                <SidebarItem icon={<Rows size={18} />} label="Week View" active={view==='week'} theme={theme} onClick={() => { setView('week'); if(isMobileMode) setIsSidebarOpen(false); }} />
                                <SidebarItem icon={<Maximize2 size={18} />} label="Focus Mode" theme={theme} onClick={() => { setSelectedDate(new Date()); setView('day'); if(isMobileMode) setIsSidebarOpen(false); }} />
                                
                                {/* New To-Do List Item with Badge */}
                                <div className="my-2 border-t border-gray-200 dark:border-gray-700 opacity-50"></div>
                                <SidebarItem 
                                    icon={<CheckSquare size={18} />} 
                                    label="To-Do List" 
                                    active={view==='todo'} 
                                    theme={theme} 
                                    onClick={() => { setView('todo'); if(isMobileMode) setIsSidebarOpen(false); }}
                                    badge={pendingTodoCount > 0 ? pendingTodoCount : null} 
                                />

                                <div className="pt-6 mt-2">
                                    <p className={`px-3 text-xs font-medium mb-3 ${theme.subText} uppercase tracking-wider`}>Calendars</p>
                                    {calendars.map(cal => (
                                        <CalendarListItem key={cal.id} calendar={cal} isActive={activeCalendarId === cal.id} isVisible={visibleCalendarIds.has(cal.id)} theme={theme}
                                            onClick={() => { setActiveCalendarId(cal.id); setVisibleCalendarIds(prev => new Set([...prev, cal.id])); }}
                                            onToggleVisibility={() => { const newSet = new Set(visibleCalendarIds); if (newSet.has(cal.id)) { if(newSet.size>1) newSet.delete(cal.id); } else newSet.add(cal.id); setVisibleCalendarIds(newSet); }}
                                            onRename={(n) => setCalendars(calendars.map(c => c.id === cal.id ? { ...c, name: n } : c))}
                                            onChangeColor={(i) => setCalendars(calendars.map(c => c.id === cal.id ? { ...c, colorIndex: i } : c))}
                                            onDelete={() => { if(calendars.length<=1) return; setCalendars(calendars.filter(c=>c.id!==cal.id)); setActiveCalendarId(calendars.find(c=>c.id!==cal.id).id); }}
                                        />
                                    ))}
                                    <button onClick={() => { const newId = generateId(); setCalendars([...calendars, { id: newId, name: 'New Calendar', colorIndex: calendars.length % 7 }]); setActiveCalendarId(newId); setVisibleCalendarIds(prev => new Set([...prev, newId])); }} className={`w-full flex items-center gap-2 px-3 py-2 text-sm ${theme.subText} hover:text-gray-900`}><Plus size={14} /> Add calendar</button>
                                </div>
                            </div>
                            <div className={`mt-auto pt-4 border-t ${theme.border} space-y-2`}>
                                <button onClick={() => setIsCloudModalOpen(true)} className={`w-full flex items-center gap-2 p-2 rounded-lg text-xs font-medium transition-colors ${githubConfig.token ? 'bg-green-50 text-green-700 border border-green-100' : 'bg-gray-100 text-gray-500 hover:bg-gray-200'}`}>{githubConfig.token ? <Wifi size={14} /> : <WifiOff size={14}/>}<span className="flex-1 text-left">{githubConfig.token ? 'Cloud Synced' : 'Cloud Off'}</span></button>
                                <div className="grid grid-cols-2 gap-2"><button onClick={() => importInputRef.current?.click()} className={`flex items-center justify-center gap-1.5 p-2 rounded-lg border ${theme.border} hover:bg-gray-50 text-xs ${theme.subText}`}><FileUp size={14} /> Import</button><button onClick={handleExportBackup} className={`flex items-center justify-center gap-1.5 p-2 rounded-lg border ${theme.border} hover:bg-gray-50 text-xs ${theme.subText}`}><FileDown size={14} /> Export</button></div>
                                <div className={`flex items-center gap-2 px-1 py-1 text-[10px] ${saveStatus === 'error' ? 'text-red-500' : theme.subText}`}>{saveStatus === 'saving' ? <div className="spinner border-gray-400"/> : (saveStatus === 'saved' ? <Check size={12}/> : <div className="w-3"/>)}<span>{saveStatus === 'saving' ? 'Syncing...' : (saveStatus === 'saved' ? 'Saved ' + (lastSaved ? format(lastSaved, 'HH:mm') : '') : (saveStatus === 'error' ? 'Sync Failed' : 'Ready'))}</span></div>
                            </div>
                        </div>
                    </motion.div>

                    <div className={`flex-1 flex flex-col h-full overflow-hidden relative ${theme.bg}`}>
                        <header className={`flex-shrink-0 px-4 md:px-8 pt-6 pb-2 ${theme.header} border-b ${theme.border}`}>
                            <div className="flex justify-between items-center mb-4">
                                <div className="flex items-center gap-4">
                                    <button onClick={() => setIsSidebarOpen(!isSidebarOpen)} className={`p-2 -ml-2 ${theme.subText}`} title={isSidebarOpen ? "Collapse Sidebar" : "Expand Sidebar"}><Menu size={20}/></button>
                                    
                                    {/* Conditional Header based on View */}
                                    {view === 'todo' ? (
                                        <div className="hidden md:flex items-center gap-2">
                                            <h1 className={`text-xl md:text-2xl font-bold ${theme.text}`}>To-Do List</h1>
                                            <span className={`text-sm ${theme.subText} px-2 py-0.5 rounded-full bg-gray-100 dark:bg-gray-800`}>
                                                {calendars.find(c => c.id === activeCalendarId)?.name}
                                            </span>
                                        </div>
                                    ) : (
                                        <>
                                            <div className="flex flex-col cursor-pointer group" onClick={() => setIsDatePickerOpen(!isDatePickerOpen)}>
                                                <div className="flex items-center gap-2"><h1 className={`text-xl md:text-2xl font-bold ${theme.text}`}>{format(currentDate, 'MMMM yyyy')}</h1><ChevronDown size={18} className={`${theme.subText}`} /></div>
                                                {isDatePickerOpen && <div className="absolute top-16 z-50"><DatePicker currentDate={currentDate} onChange={(d) => { setCurrentDate(d); setIsDatePickerOpen(false); }} theme={theme} /></div>}
                                            </div>
                                            <div className={`flex items-center ${theme.card} border ${theme.border} rounded-lg shadow-sm h-9 ml-2 md:ml-0`}>
                                                <button onClick={() => handleNavigate('prev')} className={`px-2 h-full border-r ${theme.border} hover:bg-gray-50`}><ChevronLeft size={16}/></button>
                                                <button onClick={() => { const today=new Date(); setCurrentDate(today); setSelectedDate(today); }} className={`px-3 h-full text-xs font-semibold uppercase`}>{isMobileMode ? <span className="text-[10px]">T</span> : 'Today'}</button>
                                                <button onClick={() => handleNavigate('next')} className={`px-2 h-full border-l ${theme.border} hover:bg-gray-50`}><ChevronRight size={16}/></button>
                                            </div>
                                        </>
                                    )}
                                </div>
                                <div className="flex items-center gap-2">
                                    <button onClick={() => setIsLocked(true)} className={`p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors ${theme.subText}`} title="Lock Now"><Lock size={18} /></button>
                                    <button onClick={() => setAutoLockDisabled(!autoLockDisabled)} className={`p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors ${autoLockDisabled ? 'text-amber-500' : theme.subText}`} title={autoLockDisabled ? "Auto-Lock DISABLED (Stay Awake)" : "Auto-Lock ENABLED (15 min)"}>{autoLockDisabled ? <Unlock size={18} /> : <Shield size={18} />}</button>
                                    <div className="relative hidden md:block">
                                        <Search size={14} className={`absolute left-2.5 top-2.5 ${theme.subText}`} />
                                        <input ref={searchInputRef} value={searchQuery} onChange={e => setSearchQuery(e.target.value)} placeholder="Search" className={`pl-8 pr-2 py-1.5 rounded-lg border ${theme.border} text-sm w-48 focus:ring-1 focus:ring-gray-200 ${theme.card} ${theme.text}`} />
                                    </div>
                                    <div className="flex border rounded-lg overflow-hidden border-gray-200">
                                        <button onClick={toggleLayoutMode} className={`p-2 transition-colors ${theme.card} ${theme.text} hover:bg-gray-100 border-r ${theme.border}`}>{isMobileMode ? <Monitor size={14}/> : <Smartphone size={14}/>}</button>
                                        <ThemeBtn mode="light" current={themeMode} set={setThemeMode} icon={<Sun size={14} />} />
                                        <ThemeBtn mode="dark" current={themeMode} set={setThemeMode} icon={<Moon size={14} />} />
                                        <ThemeBtn mode="eyeCare" current={themeMode} set={setThemeMode} icon={<Eye size={14} />} />
                                    </div>
                                </div>
                            </div>
                        </header>

                        <main className={`flex-1 overflow-hidden relative ${theme.bg}`} onClick={() => setIsDatePickerOpen(false)}>
                             <AnimatePresence mode="wait">
                                {view === 'month' ? (
                                    <CalendarView key="month" viewType="month" currentDate={currentDate} entries={entries} entryColors={entryColors} calendars={calendars} activeCalendarId={activeCalendarId} visibleCalendarIds={visibleCalendarIds} theme={theme} onEntryChange={handleEntryChange} onColorChange={handleColorChange} onDayClick={(date) => setSelectedDate(date)} onDayTripleClick={(date) => { setSelectedDate(date); setView('day'); }} selectedDate={selectedDate} searchQuery={searchQuery} isMobileMode={isMobileMode} />
                                ) : view === 'week' ? (
                                     <CalendarView key="week" viewType="week" currentDate={currentDate} entries={entries} entryColors={entryColors} calendars={calendars} activeCalendarId={activeCalendarId} visibleCalendarIds={visibleCalendarIds} theme={theme} onEntryChange={handleEntryChange} onColorChange={handleColorChange} onDayClick={(date) => setSelectedDate(date)} onDayTripleClick={(date) => { setSelectedDate(date); setView('day'); }} selectedDate={selectedDate} searchQuery={searchQuery} isMobileMode={isMobileMode} />
                                ) : view === 'day' ? (
                                    <DayView key="day" date={selectedDate} entry={getEntry(selectedDate)} calendarName={calendars.find(c => c.id === activeCalendarId)?.name} calendarColorIndex={calendars.find(c => c.id === activeCalendarId)?.colorIndex} theme={theme} onChange={(text) => handleEntryChange(format(selectedDate, 'yyyy-MM-dd'), text)} onBack={() => setView(isMobileMode ? 'week' : 'month')} searchQuery={searchQuery} />
                                ) : (
                                    <TodoView 
                                        key="todo" 
                                        todos={todos[activeCalendarId] || []} 
                                        onAdd={handleTodoAdd} 
                                        onToggle={handleTodoToggle} 
                                        onDelete={handleTodoDelete} 
                                        onEdit={handleTodoEdit} 
                                        onReorder={handleTodoReorder}
                                        theme={theme} 
                                        calendarColor={CALENDAR_COLORS[calendars.find(c => c.id === activeCalendarId)?.colorIndex]} 
                                    />
                                )}
                            </AnimatePresence>
                        </main>
                    </div>
                </div>
            );
        }

        // --- New TodoItem Component for Drag & Drop ---
        function TodoItem({ todo, onToggle, onDelete, startEdit, editingId, editText, setEditText, saveEdit, theme, calendarColor }) {
            const controls = useDragControls();

            return (
                <Reorder.Item
                    value={todo}
                    dragListener={false}
                    dragControls={controls}
                    dragMomentum={false} 
                    className={`group flex items-center gap-3 p-3 rounded-xl transition-colors bg-white dark:bg-gray-800/40 hover:bg-gray-50 dark:hover:bg-gray-700/30 select-none relative shadow-sm border border-transparent hover:border-gray-100 dark:hover:border-gray-700`}
                >
                     <div
                        onPointerDown={(e) => controls.start(e)}
                        className="cursor-grab active:cursor-grabbing text-gray-300 hover:text-gray-500 touch-none flex-shrink-0 p-1"
                        style={{ touchAction: 'none' }} 
                    >
                        <GripVertical size={16} />
                    </div>

                    <button onClick={() => onToggle(todo.id)} className={`flex-shrink-0 transition-colors ${todo.completed ? 'text-gray-400' : calendarColor.value}`}>
                        {todo.completed ? <CheckCircle size={20} /> : <Circle size={20} />}
                    </button>
                    
                    {/* Edit Mode Logic */}
                    {editingId === todo.id ? (
                        <input
                            autoFocus
                            value={editText}
                            onChange={(e) => setEditText(e.target.value)}
                            onBlur={saveEdit}
                            onKeyDown={(e) => { if (e.key === 'Enter') saveEdit(); if (e.key === 'Escape') startEdit(null); }} // startEdit(null) effectively cancels
                            className={`flex-1 bg-transparent border-b border-gray-300 dark:border-gray-600 outline-none ${theme.text} text-sm pb-1`}
                        />
                    ) : (
                        <span 
                            onClick={() => startEdit(todo)}
                            className={`flex-1 text-sm transition-colors cursor-text ${todo.completed ? 'line-through text-gray-400' : theme.text}`}
                            title="Click to edit"
                        >
                            {todo.text}
                        </span>
                    )}

                    <button onClick={() => onDelete(todo.id)} className="opacity-0 group-hover:opacity-100 p-1.5 text-gray-400 hover:text-red-500 transition-colors"><Trash2 size={16} /></button>
                </Reorder.Item>
            );
        }

        // --- Todo View Component (Enhanced with Reorder) ---
        function TodoView({ todos, onAdd, onToggle, onDelete, onEdit, onReorder, theme, calendarColor }) {
            const [newTodo, setNewTodo] = useState('');
            const [editingId, setEditingId] = useState(null);
            const [editText, setEditText] = useState('');

            const handleAdd = (e) => {
                e.preventDefault();
                if (newTodo.trim()) { onAdd(newTodo); setNewTodo(''); }
            };
            
            const startEdit = (todo) => {
                if (!todo) { // cancel edit
                    setEditingId(null);
                    return;
                }
                setEditingId(todo.id);
                setEditText(todo.text);
            };

            const saveEdit = () => {
                if (editingId && editText.trim()) {
                    onEdit(editingId, editText);
                }
                setEditingId(null);
            };

            const completedCount = todos.filter(t => t.completed).length;

            return (
                <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} transition={PAGE_TRANSITION} className={`flex flex-col h-full max-w-4xl mx-auto p-4 md:p-8 w-full`}>
                    <div className={`flex-1 rounded-2xl shadow-xl border ${theme.border} flex flex-col overflow-hidden ${theme.card}`}>
                        {/* Header Stats */}
                        <div className={`px-6 py-4 border-b ${theme.border} bg-opacity-50 flex justify-between items-center`}>
                            <h2 className={`text-lg font-bold ${theme.text}`}>My Tasks</h2>
                            <div className="text-xs font-medium px-2 py-1 rounded-full bg-gray-100 dark:bg-gray-800 text-gray-500">
                                {completedCount} / {todos.length} Completed
                            </div>
                        </div>

                        {/* Input Area */}
                        <form onSubmit={handleAdd} className="p-4 border-b border-gray-100 dark:border-gray-800 flex gap-2">
                            <input 
                                type="text" 
                                value={newTodo} 
                                onChange={(e) => setNewTodo(e.target.value)} 
                                placeholder="Add a new task..." 
                                className={`flex-1 px-4 py-2 rounded-lg bg-gray-50 dark:bg-gray-900 border-none outline-none focus:ring-2 focus:ring-gray-200 dark:focus:ring-gray-700 transition-all ${theme.text}`} 
                            />
                            <button type="submit" disabled={!newTodo.trim()} className={`px-4 py-2 rounded-lg font-medium transition-colors ${!newTodo.trim() ? 'opacity-50 cursor-not-allowed bg-gray-100 text-gray-400' : 'bg-gray-900 text-white hover:bg-gray-800'}`}>Add</button>
                        </form>

                        {/* List Area - Replaced ul with Reorder.Group */}
                        <div className="flex-1 overflow-y-auto p-2">
                            {todos.length === 0 ? (
                                <div className="h-full flex flex-col items-center justify-center text-gray-400 opacity-50 gap-2">
                                    <CheckSquare size={48} strokeWidth={1} />
                                    <p className="text-sm">No tasks yet</p>
                                </div>
                            ) : (
                                <Reorder.Group axis="y" values={todos} onReorder={onReorder} className="space-y-1">
                                    {todos.map(todo => (
                                        <TodoItem 
                                            key={todo.id}
                                            todo={todo}
                                            onToggle={onToggle}
                                            onDelete={onDelete}
                                            startEdit={startEdit}
                                            editingId={editingId}
                                            editText={editText}
                                            setEditText={setEditText}
                                            saveEdit={saveEdit}
                                            theme={theme}
                                            calendarColor={calendarColor}
                                        />
                                    ))}
                                </Reorder.Group>
                            )}
                        </div>
                    </div>
                </motion.div>
            );
        }

        // --- Sub Components ---
        function SidebarItem({ icon, label, active, theme, onClick, badge }) {
            return (
                <button onClick={onClick} className={`w-full flex items-center gap-3 px-3 py-2 rounded-lg text-sm font-medium mb-0.5 ${active ? `${theme.sidebarActive} text-gray-900` : `${theme.sidebarText} hover:bg-gray-100`}`}>
                    {icon}
                    <span className="flex-1 text-left">{label}</span>
                    {badge > 0 && (
                        <span className="flex-shrink-0 bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300 text-[10px] font-bold px-1.5 py-0.5 rounded-full min-w-[1.25rem] text-center">
                            {badge}
                        </span>
                    )}
                </button>
            );
        }

        function CalendarListItem({ calendar, isActive, isVisible, theme, onClick, onToggleVisibility, onRename, onChangeColor, onDelete }) {
            const [isEditing, setIsEditing] = useState(false);
            const [editName, setEditName] = useState(calendar.name);
            const [showColorPicker, setShowColorPicker] = useState(false);
            const color = CALENDAR_COLORS[calendar.colorIndex || 0];
            return (
                <div onClick={onClick} className={`group relative flex items-center justify-between px-3 py-1.5 rounded-lg cursor-pointer transition-all text-sm ${isActive ? 'bg-gray-100' : `hover:bg-gray-50`}`}>
                    <div className="flex items-center gap-3 flex-1 overflow-hidden">
                        <div className="w-2.5 h-2.5 rounded-sm flex-shrink-0 relative" style={{ backgroundColor: color.code }} onClick={(e) => { e.stopPropagation(); setShowColorPicker(!showColorPicker); }} />
                        {showColorPicker && (
                            <>
                                <div className="fixed inset-0 z-40" onClick={(e) => { e.stopPropagation(); setShowColorPicker(false); }} />
                                <div className="absolute top-6 left-0 z-50 p-2 bg-white dark:bg-gray-800 rounded shadow-xl border border-gray-200 dark:border-gray-700 grid grid-cols-4 gap-1 w-[120px]" onClick={e=>e.stopPropagation()}>
                                    {CALENDAR_COLORS.map((c, idx) => <div key={idx} className="w-5 h-5 rounded-full cursor-pointer hover:scale-110" style={{ backgroundColor: c.code }} onClick={() => { onChangeColor(idx); setShowColorPicker(false); }} />)}
                                </div>
                            </>
                        )}
                        {isEditing ? <input value={editName} onChange={e => setEditName(e.target.value)} onClick={e => e.stopPropagation()} onBlur={()=>{ onRename(editName); setIsEditing(false); }} className="bg-transparent border-b border-gray-300 w-full outline-none text-xs" autoFocus />
                        : <span className={`truncate flex-1 font-medium ${!isVisible && !isActive ? 'opacity-50 line-through' : ''} ${color.value}`}>{calendar.name}</span>}
                    </div>
                    <div className="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                         <button onClick={(e) => { e.stopPropagation(); onToggleVisibility(); }} className={`p-0.5 rounded hover:bg-gray-200 text-gray-500`}> {isVisible ? <Eye size={12} /> : <EyeOff size={12} />} </button>
                         <button onClick={(e) => { e.stopPropagation(); setIsEditing(true); }} className="p-0.5 hover:bg-gray-200 rounded text-gray-500"><Edit2 size={12} /></button>
                         <button onClick={(e) => { e.stopPropagation(); onDelete(); }} className="p-0.5 hover:bg-red-100 hover:text-red-500 rounded text-gray-500"><Trash2 size={12} /></button>
                    </div>
                </div>
            );
        }

        function HighlightedText({ text, highlight }) {
            if (!highlight?.trim()) return <span>{text}</span>;
            const parts = text.split(new RegExp(`(${highlight})`, 'gi'));
            return <span>{parts.map((part, i) => part.toLowerCase() === highlight.toLowerCase() ? <mark key={i} className="highlight rounded-sm px-0.5">{part}</mark> : <span key={i}>{part}</span>)}</span>;
        }

        function CalendarView({ viewType, currentDate, entries, entryColors, calendars, activeCalendarId, visibleCalendarIds, theme, onEntryChange, onColorChange, onDayClick, onDayTripleClick, selectedDate, searchQuery, isMobileMode }) {
            const isMonth = viewType === 'month';
            let days;
            if (isMonth) {
                const monthStart = startOfMonth(currentDate);
                days = eachDayOfInterval({ start: startOfWeek(monthStart, { weekStartsOn: 0 }), end: endOfWeek(endOfMonth(currentDate), { weekStartsOn: 0 }) });
            } else {
                days = eachDayOfInterval({ start: startOfWeek(currentDate, { weekStartsOn: 0 }), end: endOfWeek(currentDate, { weekStartsOn: 0 }) });
            }
            const [bgPicker, setBgPicker] = useState(null);
            const clickRef = useRef({ count: 0, lastTime: 0, id: null });

            const visibleList = calendars.filter(c => visibleCalendarIds.has(c.id)).sort((a, b) => a.id === activeCalendarId ? 1 : -1);
            const otherVisibleCalendars = calendars.filter(c => visibleCalendarIds.has(c.id) && c.id !== activeCalendarId);

            // Dynamic grid rows for month view to prevent implicit 'auto' rows stretching
            const rowCount = Math.ceil(days.length / 7);
            const gridStyle = isMonth ? { gridTemplateRows: `repeat(${rowCount}, minmax(0, 1fr))` } : {};

            return (
                <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} transition={PAGE_TRANSITION} className={`flex flex-col h-full ${theme.bg}`}>
                    <div className={`grid grid-cols-7 border-b ${theme.border} ${!isMonth && isMobileMode ? 'hidden' : 'grid'}`}>
                        {['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'].map(w => <div key={w} className={`px-4 py-2 text-xs font-semibold ${theme.subText} text-center`}>{w}</div>)}
                    </div>
                    <div 
                        className={`flex-1 grid ${isMonth ? 'grid-cols-7' : (isMobileMode ? 'grid-cols-1 grid-rows-7' : 'grid-cols-7 grid-rows-1')} overflow-y-auto`}
                        style={gridStyle}
                    >
                        {days.map((day, i) => {
                            const dateStr = format(day, 'yyyy-MM-dd');
                            const isCurrent = isSameMonth(day, currentDate);
                            const colorIndex = entryColors[activeCalendarId]?.[dateStr] || 0;
                            const bgColorClass = ENTRY_BG_COLORS[colorIndex]?.class || '';
                            const opacityClass = (isMonth && !isCurrent) ? 'bg-opacity-50 opacity-50' : '';

                            return (
                                <div key={dateStr}
                                    onClick={(e) => {
                                        e.stopPropagation();
                                        const now = Date.now();
                                        if (clickRef.current.id === dateStr && (now - clickRef.current.lastTime) < 400) clickRef.current.count++; else clickRef.current = { count: 1, id: dateStr, lastTime: now };
                                        onDayClick(day);
                                        if (clickRef.current.count >= 3) onDayTripleClick(day);
                                    }}
                                    className={`relative flex flex-col border-b border-r ${theme.border} ${bgColorClass} ${opacityClass} ${isSameDay(day, selectedDate) ? 'ring-inset ring-2 ring-indigo-400' : ''} group transition-colors`}
                                >
                                    <div className="flex justify-between p-1 items-center flex-shrink-0">
                                        <div className="flex items-center gap-2">
                                            {!isMonth && isMobileMode && <span className={`text-xs font-bold ${theme.subText} uppercase w-8`}>{format(day, 'EEE')}</span>}
                                            <span className={`text-xs font-medium ${isToday(day) ? 'bg-gray-900 text-white w-6 h-6 flex items-center justify-center rounded-full' : theme.text}`}>{format(day, "d")}</span>
                                        </div>
                                        <button className="opacity-0 group-hover:opacity-100 p-1.5 text-gray-400 hover:text-gray-600 transition-colors" onClick={(e) => { e.stopPropagation(); const r = e.currentTarget.getBoundingClientRect(); setBgPicker({ dateStr, top: r.bottom, left: r.right - 120 }); }}><div className="w-2 h-2 rounded-full bg-current opacity-50 hover:opacity-100"></div></button>
                                    </div>
                                    
                                    <div className="flex-1 w-full flex flex-col gap-1 overflow-hidden min-h-0 px-2 pb-2 mini-cell-content">
                                        {otherVisibleCalendars.map(cal => {
                                            const txt = entries[cal.id]?.[dateStr];
                                            if (!txt) return null;
                                            const calColor = CALENDAR_COLORS[cal.colorIndex || 0];
                                            const preview = stripHtml(txt);
                                            return (
                                                <div key={cal.id} className={`text-xs ${calColor.value} opacity-90 truncate flex-shrink-0`}>
                                                    <HighlightedText text={preview} highlight={searchQuery} />
                                                </div>
                                            );
                                        })}
                                        
                                        {/* Editable Content Area */}
                                        <div
                                            className={`w-full h-full text-xs md:text-sm leading-relaxed ${theme.text} break-words whitespace-pre-wrap outline-none overflow-y-auto scrollbar-thin scrollbar-thumb-gray-200 dark:scrollbar-thumb-gray-600 cursor-text`}
                                            contentEditable={true}
                                            suppressContentEditableWarning={true}
                                            onBlur={(e) => {
                                                const html = e.currentTarget.innerHTML;
                                                if (html !== (entries[activeCalendarId]?.[dateStr] || '')) {
                                                    onEntryChange(dateStr, html);
                                                }
                                            }}
                                            dangerouslySetInnerHTML={{ __html: entries[activeCalendarId]?.[dateStr] || '' }}
                                            onClick={(e) => {
                                                e.stopPropagation();
                                                const now = Date.now();
                                                if (clickRef.current.id === dateStr && (now - clickRef.current.lastTime) < 400) clickRef.current.count++; else clickRef.current = { count: 1, id: dateStr, lastTime: now };
                                                onDayClick(day);
                                                if (clickRef.current.count >= 3) onDayTripleClick(day);
                                            }}
                                        />
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                    {bgPicker && (
                        <>
                            <div className="fixed inset-0 z-40" onClick={() => setBgPicker(null)} />
                            <div className="fixed z-50 p-3 rounded-xl shadow-xl border bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700 grid grid-cols-5 gap-2" style={{ top: bgPicker.top, left: bgPicker.left }}>
                                {ENTRY_BG_COLORS.map((c, idx) => (
                                    <div key={idx} 
                                        className={`w-6 h-6 rounded-full cursor-pointer ${c.class || 'bg-white'} border border-black/5 hover:scale-110 transition-transform relative`} 
                                        style={{backgroundColor: c.code}}
                                        onClick={() => { onColorChange(bgPicker.dateStr, idx); setBgPicker(null); }}
                                    >
                                    </div>
                                ))}
                            </div>
                        </>
                    )}
                </motion.div>
            );
        }

        function DayView({ date, entry, calendarName, calendarColorIndex, theme, onChange, onBack, searchQuery }) {
            const editorRef = useRef(null);
            const fileInputRef = useRef(null);

             useEffect(() => {
                // Focus / Highlight logic
            }, [searchQuery, entry]);

            // Sync contentEditable with entry state when entry changes externally (e.g. date change)
            useEffect(() => {
                if (editorRef.current) {
                    let html = entry || '';
                    if (html && !html.includes('<') && html.includes('\n')) {
                        html = html.replace(/\n/g, '<br>');
                    }
                    if (editorRef.current.innerHTML !== html) {
                        editorRef.current.innerHTML = html;
                    }
                }
            }, [date, entry]); 

            const handleInput = (e) => {
                const html = e.currentTarget.innerHTML;
                onChange(html);
            };

            const handlePaste = (e) => {
                const items = e.clipboardData.items;
                for (let i = 0; i < items.length; i++) {
                    if (items[i].type.indexOf('image') !== -1) {
                        e.preventDefault();
                        const blob = items[i].getAsFile();
                        insertImage(blob);
                    }
                }
            };

            const handleFileSelect = (e) => {
                if (e.target.files && e.target.files[0]) {
                    insertImage(e.target.files[0]);
                }
                e.target.value = null; // Reset
            };

            // --- Updated: Image Compression Logic ---
            const insertImage = (file) => {
                const MAX_WIDTH = 800; // Limit image width to 800px
                const QUALITY = 0.6;   // Compress quality to 60%

                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        // Create canvas for compression
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        // Resize logic
                        if (width > MAX_WIDTH) {
                            height = Math.round((height * MAX_WIDTH) / width);
                            width = MAX_WIDTH;
                        }

                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        // Convert to compressed JPEG Data URL
                        const compressedDataUrl = canvas.toDataURL('image/jpeg', QUALITY);
                        
                        // Insert compressed image
                        document.execCommand('insertHTML', false, `<img src="${compressedDataUrl}" />`);
                        
                        // Trigger state update
                        if(editorRef.current) {
                            onChange(editorRef.current.innerHTML);
                        }
                    };
                };
                reader.readAsDataURL(file);
            };

            return (
                <motion.div initial={{ opacity: 0, scale: 0.98 }} animate={{ opacity: 1, scale: 1 }} transition={PAGE_TRANSITION} className="flex flex-col h-full max-w-3xl mx-auto p-4 md:p-8 w-full relative">
                    <button onClick={onBack} className="md:hidden mb-2 text-sm text-gray-500 flex items-center gap-1"><ChevronLeft size={16}/> Back</button>
                    <div className={`rounded-2xl shadow-xl border ${theme.border} flex flex-col h-full overflow-hidden ${theme.card} relative`}>
                        <div className={`px-6 py-4 border-b ${theme.border} bg-opacity-50`}>
                            <h2 className={`text-2xl font-bold ${theme.text}`}>{format(date, 'd MMMM yyyy')}</h2>
                            <p className={`text-xs uppercase tracking-wide ${CALENDAR_COLORS[calendarColorIndex || 0].value}`}>{format(date, 'EEEE')} • {calendarName}</p>
                        </div>
                        
                        {/* Rich Text Editor Div */}
                        <div 
                            ref={editorRef}
                            contentEditable
                            onInput={handleInput}
                            onPaste={handlePaste}
                            className={`rich-editor flex-1 w-full p-6 text-lg leading-relaxed outline-none overflow-y-auto bg-transparent ${theme.text} ${CALENDAR_COLORS[calendarColorIndex || 0].value}`} 
                            placeholder="Write here..."
                        />
                        
                        {/* Floating Add Image Button */}
                        <div className="absolute bottom-6 right-6">
                            <button 
                                onClick={() => fileInputRef.current?.click()}
                                className="w-12 h-12 bg-gray-900 dark:bg-gray-100 text-white dark:text-gray-900 rounded-full flex items-center justify-center shadow-lg hover:scale-110 transition-transform active:scale-95"
                                title="Add Image"
                            >
                                <Plus size={24} />
                            </button>
                            <input 
                                type="file" 
                                ref={fileInputRef} 
                                className="hidden" 
                                accept="image/*" 
                                onChange={handleFileSelect} 
                            />
                        </div>
                    </div>
                </motion.div>
            );
        }

        // --- Improved DatePicker (Windows Style) ---
        function DatePicker({ currentDate, onChange, theme }) {
            const [viewMode, setViewMode] = useState('month');
            const [viewYear, setViewYear] = useState(getYear(currentDate));
            const months = Array.from({ length: 12 }, (_, i) => i);
            const startYear = viewYear - 5;
            const years = Array.from({ length: 12 }, (_, i) => startYear + i);

            return (
                <div className={`p-4 rounded-xl shadow-2xl border ${theme.border} ${theme.card} w-64 animate-in fade-in zoom-in-95 duration-150`}>
                    <div className="flex justify-between items-center mb-4">
                        <button onClick={() => { if(viewMode==='month') onChange(subYears(currentDate, 1)); else setViewYear(viewYear - 12); }} className={`p-1 hover:bg-gray-100 rounded ${theme.subText}`}><ChevronLeft size={16}/></button>
                        <button onClick={() => setViewMode(viewMode === 'month' ? 'year' : 'month')} className={`font-semibold hover:bg-gray-100 px-2 py-1 rounded transition-colors ${theme.text}`}>{viewMode === 'month' ? format(currentDate, 'yyyy') : `${startYear} - ${startYear + 11}`}</button>
                        <button onClick={() => { if(viewMode==='month') onChange(addYears(currentDate, 1)); else setViewYear(viewYear + 12); }} className={`p-1 hover:bg-gray-100 rounded ${theme.subText}`}><ChevronRight size={16}/></button>
                    </div>
                    <div className="grid grid-cols-3 gap-2">
                        {viewMode === 'month' ? (months.map(m => (
                                <button key={m} onClick={() => onChange(setMonth(currentDate, m))} className={`py-2 rounded text-sm hover:bg-gray-50 ${getMonth(currentDate) === m ? 'bg-gray-900 text-white font-medium' : theme.text}`}>{format(new Date(2000, m, 1), 'MMM')}</button>
                            ))) : (years.map(y => (
                                <button key={y} onClick={() => { onChange(setYear(currentDate, y)); setViewMode('month'); }} className={`py-2 rounded text-sm hover:bg-gray-50 ${getYear(currentDate) === y ? 'bg-gray-900 text-white font-medium' : theme.text} ${y === getYear(new Date()) ? 'border border-gray-200' : ''}`}>{y}</button>
                            )))}
                    </div>
                </div>
            );
        }

        function ThemeBtn({ mode, current, set, icon }) {
            return <button onClick={() => set(mode)} className={`p-2 transition-colors ${current === mode ? 'bg-gray-100 text-gray-900' : 'text-gray-400 hover:text-gray-600'}`}>{icon}</button>;
        }

        const root = createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>
</body>
</html>


