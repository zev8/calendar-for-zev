<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Zev - Cloud Diary</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    colors: {
                        gray: {
                            50: '#F9FAFB', 100: '#F3F4F6', 200: '#E5E7EB', 300: '#D1D5DB',
                            400: '#9CA3AF', 500: '#6B7280', 600: '#4B5563', 700: '#374151',
                            800: '#1F2937', 900: '#111827',
                        }
                    },
                    padding: {
                        'safe-top': 'env(safe-area-inset-top)',
                        'safe-bottom': 'env(safe-area-inset-bottom)',
                    }
                }
            }
        }
    </script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .scrollbar-hover::-webkit-scrollbar { width: 4px; height: 4px; }
        .scrollbar-hover::-webkit-scrollbar-track { background: transparent; }
        .scrollbar-hover::-webkit-scrollbar-thumb { background-color: transparent; border-radius: 4px; transition: background-color 0.2s; }
        .group:hover .scrollbar-hover::-webkit-scrollbar-thumb { background-color: rgba(156, 163, 175, 0.4); }
        .scrollbar-thin::-webkit-scrollbar { width: 4px; height: 4px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: transparent; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background-color: rgba(156, 163, 175, 0.3); border-radius: 4px; }
        *:focus { outline: none; }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-4px); }
            20%, 40%, 60%, 80% { transform: translateX(4px); }
        }
        .animate-shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        .highlight { background-color: #fde047; color: black; }
        
        /* Loading Spinner */
        .spinner { border: 2px solid rgba(0,0,0,0.1); border-left-color: currentColor; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 antialiased overflow-hidden transition-colors duration-300">
    <div id="root"></div>

    <script type="importmap">
        {
            "imports": {
                "react": "https://esm.sh/react@18.3.1?dev",
                "react-dom/client": "https://esm.sh/react-dom@18.3.1/client?dev",
                "lucide-react": "https://esm.sh/lucide-react@0.263.1?external=react,react-dom",
                "date-fns": "https://esm.sh/date-fns@2.30.0",
                "date-fns/locale": "https://esm.sh/date-fns@2.30.0/locale",
                "framer-motion": "https://esm.sh/framer-motion@10.16.4?external=react,react-dom"
            }
        }
    </script>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            ChevronLeft, ChevronRight, ChevronDown, Calendar as CalendarIcon, FileText, 
            Moon, Sun, Eye, EyeOff, Download, Maximize2, Clock, Plus, Trash2, Edit2, 
            Check, X, Lock, Archive, Search, Settings, HelpCircle, Bell, Menu, Upload, 
            FolderOpen, Save, HardDrive, FileJson, RefreshCw, Link as LinkIcon, Palette,
            Cloud, Wifi, WifiOff, Copy, LogOut, FileDown, FileUp, LayoutGrid, Rows
        } from 'lucide-react';
        import { 
            format, addMonths, subMonths, startOfMonth, endOfMonth, 
            startOfWeek, endOfWeek, eachDayOfInterval, isSameMonth, isSameDay,
            addDays, subDays, isToday, setMonth, setYear, getYear, getMonth, parseISO,
            addWeeks, subWeeks
        } from 'date-fns';
        import { enUS } from 'date-fns/locale';
        import { motion, AnimatePresence } from 'framer-motion';

        // --- GitHub API Helper ---
        const GIST_FILENAME = "zev_diary_data.json";
        
        const getGist = async (token, gistId) => {
            const res = await fetch(`https://api.github.com/gists/${gistId}`, {
                headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json' }
            });
            if (!res.ok) throw new Error('Failed to fetch Gist');
            const data = await res.json();
            const content = data.files[GIST_FILENAME]?.content;
            return content ? JSON.parse(content) : null;
        };

        const createGist = async (token, content) => {
            const res = await fetch('https://api.github.com/gists', {
                method: 'POST',
                headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json' },
                body: JSON.stringify({
                    description: "Zev Diary Sync Data",
                    public: false,
                    files: { [GIST_FILENAME]: { content: JSON.stringify(content, null, 2) } }
                })
            });
            if (!res.ok) throw new Error('Failed to create Gist');
            return await res.json();
        };

        const updateGist = async (token, gistId, content) => {
            const res = await fetch(`https://api.github.com/gists/${gistId}`, {
                method: 'PATCH',
                headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json' },
                body: JSON.stringify({
                    files: { [GIST_FILENAME]: { content: JSON.stringify(content, null, 2) } }
                })
            });
            if (!res.ok) throw new Error('Failed to update Gist');
            return await res.json();
        };

        // --- Constants ---
        const THEMES = {
            light: {
                name: 'Light', bg: 'bg-white', sidebar: 'bg-gray-50 border-r border-gray-200', sidebarText: 'text-gray-500', sidebarActive: 'bg-gray-100', 
                header: 'bg-white', card: 'bg-white', text: 'text-gray-900', subText: 'text-gray-500', border: 'border-gray-200',
                dayBg: 'bg-white', dayHover: 'hover:bg-gray-50', lockBg: 'bg-gray-50',
            },
            dark: {
                name: 'Dark', bg: 'bg-gray-900', sidebar: 'bg-gray-800 border-r border-gray-700', sidebarText: 'text-gray-400', sidebarActive: 'bg-gray-700 text-white',
                header: 'bg-gray-900', card: 'bg-gray-800', text: 'text-gray-100', subText: 'text-gray-500', border: 'border-gray-700',
                dayBg: 'bg-gray-900', dayHover: 'hover:bg-gray-800', lockBg: 'bg-gray-950',
            },
            eyeCare: {
                name: 'Eye Care', bg: 'bg-[#f5f1e6]', sidebar: 'bg-[#e8e4d9] border-r border-[#dcd7cb]', sidebarText: 'text-[#5c5548]', sidebarActive: 'bg-[#dcd7cb] text-[#3e3931]',
                header: 'bg-[#f5f1e6]', card: 'bg-[#fdfbf7]', text: 'text-[#3e3931]', subText: 'text-[#968e81]', border: 'border-[#dcd7cb]',
                dayBg: 'bg-[#fdfbf7]', dayHover: 'hover:bg-[#f5f1e6]', lockBg: 'bg-[#e8e4d9]',
            }
        };

        const CALENDAR_COLORS = [
            { name: 'Ink', value: 'text-gray-900 dark:text-gray-100', code: '#111827' },
            { name: 'Red', value: 'text-red-600 dark:text-red-400', code: '#dc2626' },
            { name: 'Orange', value: 'text-orange-600 dark:text-orange-400', code: '#ea580c' },
            { name: 'Green', value: 'text-emerald-600 dark:text-emerald-400', code: '#059669' },
            { name: 'Blue', value: 'text-blue-600 dark:text-blue-400', code: '#2563eb' },
            { name: 'Purple', value: 'text-purple-600 dark:text-purple-400', code: '#9333ea' },
            { name: 'Pink', value: 'text-pink-600 dark:text-pink-400', code: '#db2777' },
        ];
        
        const ENTRY_BG_COLORS = [
            { name: 'Default', class: '', code: 'transparent' },
            { name: 'Warm Red', class: 'bg-red-50 dark:bg-red-900/20', code: '#fef2f2' },
            { name: 'Orange', class: 'bg-orange-50 dark:bg-orange-900/20', code: '#fff7ed' },
            { name: 'Amber', class: 'bg-amber-50 dark:bg-amber-900/20', code: '#fffbeb' },
            { name: 'Green', class: 'bg-emerald-50 dark:bg-emerald-900/20', code: '#ecfdf5' },
            { name: 'Teal', class: 'bg-teal-50 dark:bg-teal-900/20', code: '#f0fdfa' },
            { name: 'Blue', class: 'bg-blue-50 dark:bg-blue-900/20', code: '#eff6ff' },
            { name: 'Indigo', class: 'bg-indigo-50 dark:bg-indigo-900/20', code: '#eef2ff' },
            { name: 'Purple', class: 'bg-purple-50 dark:bg-purple-900/20', code: '#faf5ff' },
            { name: 'Rose', class: 'bg-rose-50 dark:bg-rose-900/20', code: '#fff1f2' },
        ];

        const generateId = () => Math.random().toString(36).substr(2, 9);

        // --- Lock Screen ---
        function LockScreen({ onUnlock, theme }) {
            const [password, setPassword] = useState('');
            const [error, setError] = useState(false);
            const [shake, setShake] = useState(false);
            
            const handleUnlock = (e) => {
                if(e) e.preventDefault();
                onUnlock();
            };

            useEffect(() => {
                const handleKeyDown = (e) => { if (e.key === 'Escape') onUnlock(); };
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [onUnlock]);
            
            return (
                <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }} className={`fixed inset-0 z-50 flex items-center justify-center ${theme.lockBg} ${theme.text}`}>
                    <div className={`flex flex-col items-center gap-6 p-10 rounded-3xl w-full max-w-sm ${shake ? 'animate-shake' : ''}`}>
                        <div 
                            onClick={handleUnlock}
                            className={`w-20 h-20 rounded-2xl flex items-center justify-center shadow-lg mb-2 bg-white border ${theme.border} cursor-pointer active:scale-95 transition-transform`}
                        >
                            <Lock size={32} className="text-gray-900" />
                        </div>
                        <div className="text-center">
                            <h1 className="text-2xl font-semibold">Welcome back</h1>
                            <p className={`text-sm mt-2 ${theme.subText}`}>Tap icon to unlock</p>
                        </div>
                        
                        <form onSubmit={handleUnlock} className="w-full relative opacity-0 h-0 overflow-hidden">
                             <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} />
                        </form>

                        <button onClick={handleUnlock} className="w-full py-3.5 rounded-xl font-medium shadow-sm bg-gray-900 text-white hover:bg-gray-800 active:scale-95 transition-all">
                            Enter Diary
                        </button>
                    </div>
                </motion.div>
            );
        }

        // --- Cloud Settings Modal (Modified for Safe Sync) ---
        function CloudSettingsModal({ isOpen, onClose, config, onConnectSuccess, onDisconnect, theme }) {
            const [token, setToken] = useState(config.token || '');
            const [gistId, setGistId] = useState(config.gistId || '');
            const [isLoading, setIsLoading] = useState(false);
            const [error, setError] = useState('');

            useEffect(() => {
                 setToken(config.token || '');
                 setGistId(config.gistId || '');
            }, [config, isOpen]);

            const handleConnect = async (isNew) => {
                if (!token) return setError('Token is required');
                setIsLoading(true);
                setError('');
                try {
                    let id = gistId;
                    let data = null;

                    if (isNew) {
                        // Creating new: Safe to overwrite/create
                        const newGist = await createGist(token, { calendars: [], entries: {}, entryColors: {}, themeMode: 'light' });
                        id = newGist.id;
                    } else {
                        // Connecting existing: MUST READ FIRST
                        if (!id) return setError('Gist ID is required for existing connection');
                        data = await getGist(token, id);
                        if (!data) throw new Error("Could not retrieve data from Gist");
                    }
                    
                    // Crucial Step: Pass data back to App to update state BEFORE saving config
                    onConnectSuccess(token, id, data);
                    onClose();
                } catch (e) {
                    setError(e.message);
                } finally {
                    setIsLoading(false);
                }
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/20 backdrop-blur-sm p-4 animate-in fade-in zoom-in-95 duration-200">
                    <div className={`w-full max-w-md p-6 rounded-2xl shadow-2xl ${theme.card} ${theme.text} border ${theme.border}`}>
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-lg font-semibold flex items-center gap-2"><Cloud size={20}/> Cloud Sync (GitHub)</h2>
                            <button onClick={onClose}><X size={18} className={theme.subText}/></button>
                        </div>
                        
                        {config.token && config.gistId ? (
                            <div className="space-y-4">
                                <div className={`p-4 rounded-lg bg-green-50 border border-green-100 text-green-800 text-sm`}>
                                    <div className="flex items-center gap-2 font-medium mb-1"><Wifi size={16}/> Connected</div>
                                    <p className="opacity-80">Your diary is syncing to GitHub Gist.</p>
                                </div>
                                <div>
                                    <label className="text-xs font-medium uppercase opacity-50 block mb-1">Gist ID (Copy this for other devices)</label>
                                    <div className="flex gap-2">
                                        <code className="flex-1 p-2 bg-gray-100 rounded text-xs truncate">{config.gistId}</code>
                                        <button onClick={() => navigator.clipboard.writeText(config.gistId)} className="p-2 hover:bg-gray-200 rounded"><Copy size={14}/></button>
                                    </div>
                                </div>
                                <button onClick={onDisconnect} className="w-full py-2.5 rounded-lg border border-red-200 text-red-600 hover:bg-red-50 text-sm font-medium mt-4">Disconnect</button>
                            </div>
                        ) : (
                            <div className="space-y-4">
                                <div>
                                    <label className="text-xs font-medium uppercase opacity-50 block mb-1">GitHub Personal Access Token</label>
                                    <input type="password" value={token} onChange={e=>setToken(e.target.value)} placeholder="ghp_xxxxxxxxxxxx" className={`w-full p-2.5 rounded-lg border ${theme.border} bg-transparent text-sm focus:ring-2 focus:ring-gray-200`} />
                                    <p className="text-[10px] mt-1 opacity-50">Requires "gist" scope.</p>
                                </div>
                                <div className="grid grid-cols-2 gap-3 pt-2">
                                    <button onClick={() => handleConnect(true)} disabled={isLoading} className="flex flex-col items-center justify-center gap-2 p-4 rounded-xl border border-gray-200 hover:border-gray-400 hover:bg-gray-50 transition-all">
                                        <Plus size={20} className="opacity-50"/>
                                        <span className="text-sm font-medium">New Gist</span>
                                    </button>
                                    <button onClick={() => { if(!gistId) { setError('Enter Gist ID below'); return; } handleConnect(false); }} disabled={isLoading} className="flex flex-col items-center justify-center gap-2 p-4 rounded-xl border border-gray-200 hover:border-gray-400 hover:bg-gray-50 transition-all">
                                        <Download size={20} className="opacity-50"/>
                                        <span className="text-sm font-medium">Load Existing</span>
                                    </button>
                                </div>
                                <div>
                                    <label className="text-xs font-medium uppercase opacity-50 block mb-1">Or Existing Gist ID</label>
                                    <input value={gistId} onChange={e=>setGistId(e.target.value)} placeholder="e.g. 8f44..." className={`w-full p-2.5 rounded-lg border ${theme.border} bg-transparent text-sm focus:ring-2 focus:ring-gray-200`} />
                                </div>
                                {error && <p className="text-xs text-red-500">{error}</p>}
                                {isLoading && <p className="text-xs text-center opacity-50">Connecting...</p>}
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // --- Main App ---
        function App() {
            // Screen Size Detection
            const [isMobile, setIsMobile] = useState(window.innerWidth < 768);
            
            // Data State
            const [calendars, setCalendars] = useState([{ id: 'default', name: 'My Diary', colorIndex: 4 }]);
            const [entries, setEntries] = useState({ 'default': {} });
            const [entryColors, setEntryColors] = useState({});
            const [activeCalendarId, setActiveCalendarId] = useState('default');
            const [visibleCalendarIds, setVisibleCalendarIds] = useState(new Set(['default']));
            
            // UI State
            const [currentDate, setCurrentDate] = useState(new Date());
            const [selectedDate, setSelectedDate] = useState(new Date());
            const [view, setView] = useState(window.innerWidth < 768 ? 'week' : 'month'); // Default to week on mobile
            const [themeMode, setThemeMode] = useState('light');
            const [isSidebarOpen, setIsSidebarOpen] = useState(window.innerWidth >= 768); // Default closed on mobile
            const [isDatePickerOpen, setIsDatePickerOpen] = useState(false);
            const [isLocked, setIsLocked] = useState(true);
            const [searchQuery, setSearchQuery] = useState('');
            const [isCloudModalOpen, setIsCloudModalOpen] = useState(false);

            // Storage State
            const [githubConfig, setGithubConfig] = useState({ token: '', gistId: '' });
            const [saveStatus, setSaveStatus] = useState('idle'); // idle, saving, saved, error
            const [lastSaved, setLastSaved] = useState(null);
            
            const theme = THEMES[themeMode];
            const searchInputRef = useRef(null);
            const importInputRef = useRef(null);
            const saveTimeoutRef = useRef(null);
            const activityTimerRef = useRef(null);

            // Handle Resize
            useEffect(() => {
                const handleResize = () => {
                    const mobile = window.innerWidth < 768;
                    setIsMobile(mobile);
                };
                window.addEventListener('resize', handleResize);
                return () => window.removeEventListener('resize', handleResize);
            }, []);

            // Initial Load
            useEffect(() => {
                const load = async () => {
                    // Load Settings
                    const savedTheme = localStorage.getItem('diary_theme');
                    if (savedTheme && THEMES[savedTheme]) setThemeMode(savedTheme);
                    
                    const savedGithub = localStorage.getItem('diary_github_config');
                    let ghConfig = null;
                    if (savedGithub) {
                        ghConfig = JSON.parse(savedGithub);
                        setGithubConfig(ghConfig);
                    }

                    // Try loading from Cloud first if configured
                    if (ghConfig && ghConfig.token && ghConfig.gistId) {
                        try {
                            setSaveStatus('saving');
                            const data = await getGist(ghConfig.token, ghConfig.gistId);
                            if (data) applyData(data);
                            setSaveStatus('saved');
                        } catch (e) {
                            console.error("Gist Load Failed", e);
                            setSaveStatus('error');
                        }
                    } else {
                        // Fallback to LocalStorage
                        try {
                            const lsCals = localStorage.getItem('diary_calendars');
                            const lsEntries = localStorage.getItem('diary_entries');
                            const lsColors = localStorage.getItem('diary_entry_colors');
                            if (lsCals && lsEntries) {
                                setCalendars(JSON.parse(lsCals));
                                setEntries(JSON.parse(lsEntries));
                                if (lsColors) setEntryColors(JSON.parse(lsColors));
                            }
                        } catch (e) {}
                    }
                };
                load();
            }, []);

            // Auto-Save Logic
            useEffect(() => {
                // Save to LocalStorage (Always backup)
                localStorage.setItem('diary_entries', JSON.stringify(entries));
                localStorage.setItem('diary_entry_colors', JSON.stringify(entryColors));
                localStorage.setItem('diary_calendars', JSON.stringify(calendars));
                localStorage.setItem('diary_theme', themeMode);

                if (saveTimeoutRef.current) clearTimeout(saveTimeoutRef.current);
                
                // Debounced Cloud Save
                if (githubConfig.token) {
                    setSaveStatus('saving');
                    saveTimeoutRef.current = setTimeout(async () => {
                        const data = { calendars, entries, entryColors, themeMode };
                        try {
                            if (githubConfig.token && githubConfig.gistId) {
                                await updateGist(githubConfig.token, githubConfig.gistId, data);
                            }
                            setLastSaved(new Date());
                            setSaveStatus('saved');
                            setTimeout(() => setSaveStatus('idle'), 2000);
                        } catch (err) {
                            console.error("Auto-save failed:", err);
                            setSaveStatus('error');
                        }
                    }, 2000); // 2 second delay
                }
            }, [entries, entryColors, calendars, themeMode, githubConfig]);

            const applyData = (data) => {
                if(!data) return;
                if (data.calendars) setCalendars(data.calendars);
                if (data.entries) setEntries(data.entries);
                if (data.entryColors) setEntryColors(data.entryColors);
                if (data.themeMode) setThemeMode(data.themeMode);
                if (data.calendars && data.calendars.length > 0) {
                     setActiveCalendarId(data.calendars[0].id);
                     setVisibleCalendarIds(new Set([data.calendars[0].id]));
                }
            };

            // Activity Timer for Lock Screen
            const resetActivityTimer = () => {
                if (activityTimerRef.current) clearTimeout(activityTimerRef.current);
                activityTimerRef.current = setTimeout(() => { setIsLocked(true); }, 5 * 60 * 1000);
            };
            useEffect(() => {
                const events = ['mousedown', 'keydown', 'touchstart', 'scroll'];
                const handler = () => { if (!isLocked) resetActivityTimer(); };
                events.forEach(e => window.addEventListener(e, handler));
                return () => { events.forEach(e => window.removeEventListener(e, handler)); };
            }, [isLocked]);

            // Handlers
            const handleEntryChange = (dateStr, text) => {
                setEntries(prev => ({ ...prev, [activeCalendarId]: { ...(prev[activeCalendarId] || {}), [dateStr]: text } }));
            };
            
            const handleColorChange = (dateStr, colorIndex) => {
                setEntryColors(prev => ({ ...prev, [activeCalendarId]: { ...(prev[activeCalendarId] || {}), [dateStr]: colorIndex } }));
            };

            // Safe Connect: Apply Data FIRST, then Save Config
            const handleConnectSuccess = (token, gistId, data) => {
                if(data) {
                    applyData(data);
                }
                const config = { token, gistId };
                setGithubConfig(config);
                localStorage.setItem('diary_github_config', JSON.stringify(config));
                setSaveStatus('saved'); // Don't trigger 'saving' immediately, assume synced
            };

            const handleCloudDisconnect = () => {
                if(confirm("Disconnect cloud sync? Your data will remain on Gist but stop syncing here.")){
                    setGithubConfig({ token: '', gistId: '' });
                    localStorage.removeItem('diary_github_config');
                    setIsCloudModalOpen(false);
                }
            };

            // Universal Backup Functions (Works on Mobile & Desktop)
            const handleExportBackup = () => {
                const data = { calendars, entries, entryColors, themeMode };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `zev_diary_backup_${format(new Date(), 'yyyy-MM-dd')}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };

            const handleImportBackup = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (confirm("Restore backup? Current entries will be updated.")) {
                            applyData(data);
                            alert("Backup restored successfully!");
                        }
                    } catch (err) {
                        alert("Failed to parse file.");
                    }
                };
                reader.readAsText(file);
                event.target.value = null; 
            };

            const handleUnlock = () => {
                setIsLocked(false);
            };

            const handleNavigate = (direction) => {
                if (view === 'month') {
                    setCurrentDate(prev => direction === 'prev' ? subMonths(prev, 1) : addMonths(prev, 1));
                } else if (view === 'week') {
                    setCurrentDate(prev => direction === 'prev' ? subWeeks(prev, 1) : addWeeks(prev, 1));
                } else {
                    setSelectedDate(prev => {
                        const newDate = direction === 'prev' ? subDays(prev, 1) : addDays(prev, 1);
                        if (!isSameMonth(newDate, currentDate)) setCurrentDate(newDate);
                        return newDate;
                    });
                }
            };
            
            // --- Renders ---
            const getEntry = (date) => entries[activeCalendarId]?.[format(date, 'yyyy-MM-dd')] || '';

            return (
                <div className={`flex h-screen w-full overflow-hidden ${theme.bg} ${theme.text}`}>
                    <AnimatePresence>
                        {isLocked && <LockScreen key="lock" onUnlock={handleUnlock} theme={theme} />}
                    </AnimatePresence>
                    
                    <CloudSettingsModal 
                        isOpen={isCloudModalOpen} 
                        onClose={() => setIsCloudModalOpen(false)} 
                        config={githubConfig} 
                        onConnectSuccess={handleConnectSuccess}
                        onDisconnect={handleCloudDisconnect}
                        theme={theme}
                    />

                    {/* Hidden Import Input */}
                    <input type="file" ref={importInputRef} style={{display:'none'}} accept=".json" onChange={handleImportBackup} />

                    {/* Sidebar */}
                    <motion.div animate={{ width: isSidebarOpen ? 260 : 0, opacity: isSidebarOpen ? 1 : 0 }} className={`flex-shrink-0 flex flex-col ${theme.sidebar} h-full z-20 pt-safe-top absolute md:relative shadow-2xl md:shadow-none h-full`}>
                        <div className="p-5 flex flex-col h-full pt-6">
                            {/* Mobile Close Button */}
                            <button onClick={() => setIsSidebarOpen(false)} className="md:hidden absolute top-4 right-4 p-2 text-gray-400"><X size={20}/></button>

                            <div className="space-y-1 flex-1 overflow-y-auto scrollbar-thin mt-8 md:mt-0">
                                <SidebarItem icon={<LayoutGrid size={18} />} label="Month View" active={view==='month'} theme={theme} onClick={() => { setView('month'); if(isMobile) setIsSidebarOpen(false); }} />
                                <SidebarItem icon={<Rows size={18} />} label="Week View" active={view==='week'} theme={theme} onClick={() => { setView('week'); if(isMobile) setIsSidebarOpen(false); }} />
                                <SidebarItem icon={<Maximize2 size={18} />} label="Focus Mode" theme={theme} onClick={() => { setSelectedDate(new Date()); setView('day'); if(isMobile) setIsSidebarOpen(false); }} />
                                
                                <div className="pt-6 mt-2">
                                    <p className={`px-3 text-xs font-medium mb-3 ${theme.subText} uppercase tracking-wider`}>Calendars</p>
                                    {calendars.map(cal => (
                                        <CalendarListItem 
                                            key={cal.id} 
                                            calendar={cal} 
                                            isActive={activeCalendarId === cal.id} 
                                            isVisible={visibleCalendarIds.has(cal.id)}
                                            theme={theme}
                                            onClick={() => { setActiveCalendarId(cal.id); setVisibleCalendarIds(prev => new Set([...prev, cal.id])); }}
                                            onToggleVisibility={() => { 
                                                const newSet = new Set(visibleCalendarIds);
                                                if (newSet.has(cal.id)) { if(newSet.size>1) newSet.delete(cal.id); } else newSet.add(cal.id);
                                                setVisibleCalendarIds(newSet);
                                            }}
                                            onRename={(n) => setCalendars(calendars.map(c => c.id === cal.id ? { ...c, name: n } : c))}
                                            onChangeColor={(i) => setCalendars(calendars.map(c => c.id === cal.id ? { ...c, colorIndex: i } : c))}
                                            onDelete={() => {
                                                if(calendars.length<=1) return;
                                                setCalendars(calendars.filter(c=>c.id!==cal.id));
                                                setActiveCalendarId(calendars.find(c=>c.id!==cal.id).id);
                                            }}
                                        />
                                    ))}
                                    <button onClick={() => {
                                        const newId = generateId();
                                        setCalendars([...calendars, { id: newId, name: 'New Calendar', colorIndex: calendars.length % 7 }]);
                                        setActiveCalendarId(newId);
                                        setVisibleCalendarIds(prev => new Set([...prev, newId]));
                                    }} className={`w-full flex items-center gap-2 px-3 py-2 text-sm ${theme.subText} hover:text-gray-900`}><Plus size={14} /> Add calendar</button>
                                </div>
                            </div>
                            
                            {/* Footer / Status Area */}
                            <div className={`mt-auto pt-4 border-t ${theme.border} space-y-2`}>
                                {/* Cloud Status */}
                                <button onClick={() => setIsCloudModalOpen(true)} className={`w-full flex items-center gap-2 p-2 rounded-lg text-xs font-medium transition-colors ${githubConfig.token ? 'bg-green-50 text-green-700 border border-green-100' : 'bg-gray-100 text-gray-500 hover:bg-gray-200'}`}>
                                    {githubConfig.token ? <Wifi size={14} /> : <WifiOff size={14}/>}
                                    <span className="flex-1 text-left">{githubConfig.token ? 'Cloud Synced' : 'Cloud Off'}</span>
                                    {githubConfig.token && <Settings size={12} className="opacity-50"/>}
                                </button>

                                {/* Import / Export */}
                                <div className="grid grid-cols-2 gap-2">
                                    <button onClick={() => importInputRef.current?.click()} className={`flex items-center justify-center gap-1.5 p-2 rounded-lg border ${theme.border} hover:bg-gray-50 text-xs ${theme.subText}`} title="Import Backup">
                                        <FileUp size={14} /> Import
                                    </button>
                                    <button onClick={handleExportBackup} className={`flex items-center justify-center gap-1.5 p-2 rounded-lg border ${theme.border} hover:bg-gray-50 text-xs ${theme.subText}`} title="Save to File">
                                        <FileDown size={14} /> Export
                                    </button>
                                </div>

                                {/* Save Indicator */}
                                <div className={`flex items-center gap-2 px-1 py-1 text-[10px] ${saveStatus === 'error' ? 'text-red-500' : theme.subText}`}>
                                    {saveStatus === 'saving' ? <div className="spinner border-gray-400"/> : (saveStatus === 'saved' ? <Check size={12}/> : <div className="w-3"/>)}
                                    <span>{saveStatus === 'saving' ? 'Syncing...' : (saveStatus === 'saved' ? 'Saved ' + (lastSaved ? format(lastSaved, 'HH:mm') : '') : (saveStatus === 'error' ? 'Sync Failed' : 'Ready'))}</span>
                                </div>
                            </div>
                        </div>
                    </motion.div>

                    {/* Main Content */}
                    <div className={`flex-1 flex flex-col h-full overflow-hidden relative ${theme.bg}`}>
                        {/* Header */}
                        <header className={`flex-shrink-0 px-4 md:px-8 pt-6 pb-2 ${theme.header} border-b ${theme.border}`}>
                            <div className="flex justify-between items-center mb-4">
                                <div className="flex items-center gap-4">
                                    <button onClick={() => setIsSidebarOpen(!isSidebarOpen)} className={`p-2 -ml-2 ${theme.subText}`}><Menu size={20}/></button>
                                    <div className="flex flex-col cursor-pointer group" onClick={() => setIsDatePickerOpen(!isDatePickerOpen)}>
                                        <div className="flex items-center gap-2">
                                            <h1 className={`text-xl md:text-2xl font-bold ${theme.text}`}>{format(currentDate, 'MMMM yyyy')}</h1>
                                            <ChevronDown size={18} className={`${theme.subText}`} />
                                        </div>
                                        {isDatePickerOpen && <div className="absolute top-16 z-50"><DatePicker currentDate={currentDate} onChange={(d) => { setCurrentDate(d); setIsDatePickerOpen(false); }} theme={theme} /></div>}
                                    </div>
                                    <div className={`hidden md:flex items-center ${theme.card} border ${theme.border} rounded-lg shadow-sm h-9`}>
                                        <button onClick={() => handleNavigate('prev')} className={`px-2 h-full border-r ${theme.border} hover:bg-gray-50`}><ChevronLeft size={16}/></button>
                                        <button onClick={() => { const today=new Date(); setCurrentDate(today); setSelectedDate(today); }} className={`px-3 h-full text-xs font-semibold uppercase`}>Today</button>
                                        <button onClick={() => handleNavigate('next')} className={`px-2 h-full border-l ${theme.border} hover:bg-gray-50`}><ChevronRight size={16}/></button>
                                    </div>
                                </div>
                                <div className="flex items-center gap-2">
                                    <div className="relative hidden md:block">
                                        <Search size={14} className={`absolute left-2.5 top-2.5 ${theme.subText}`} />
                                        <input ref={searchInputRef} value={searchQuery} onChange={e => setSearchQuery(e.target.value)} placeholder="Search" className={`pl-8 pr-2 py-1.5 rounded-lg border ${theme.border} text-sm w-48 focus:ring-1 focus:ring-gray-200 ${theme.card} ${theme.text}`} />
                                    </div>
                                    <div className="flex border rounded-lg overflow-hidden border-gray-200">
                                        <ThemeBtn mode="light" current={themeMode} set={setThemeMode} icon={<Sun size={14} />} />
                                        <ThemeBtn mode="dark" current={themeMode} set={setThemeMode} icon={<Moon size={14} />} />
                                        <ThemeBtn mode="eyeCare" current={themeMode} set={setThemeMode} icon={<Eye size={14} />} />
                                    </div>
                                </div>
                            </div>
                        </header>

                        {/* Views */}
                        <main className={`flex-1 overflow-hidden relative ${theme.bg}`} onClick={() => setIsDatePickerOpen(false)}>
                             <AnimatePresence mode="wait">
                                {view === 'month' ? (
                                    <CalendarView 
                                        key="month" 
                                        viewType="month"
                                        currentDate={currentDate} 
                                        entries={entries}
                                        entryColors={entryColors}
                                        calendars={calendars}
                                        activeCalendarId={activeCalendarId}
                                        visibleCalendarIds={visibleCalendarIds}
                                        theme={theme} 
                                        onEntryChange={handleEntryChange}
                                        onColorChange={handleColorChange}
                                        onDayClick={(date) => setSelectedDate(date)}
                                        onDayTripleClick={(date) => { setSelectedDate(date); setView('day'); }}
                                        selectedDate={selectedDate}
                                        searchQuery={searchQuery}
                                    />
                                ) : view === 'week' ? (
                                     <CalendarView 
                                        key="week" 
                                        viewType="week"
                                        currentDate={currentDate} 
                                        entries={entries}
                                        entryColors={entryColors}
                                        calendars={calendars}
                                        activeCalendarId={activeCalendarId}
                                        visibleCalendarIds={visibleCalendarIds}
                                        theme={theme} 
                                        onEntryChange={handleEntryChange}
                                        onColorChange={handleColorChange}
                                        onDayClick={(date) => setSelectedDate(date)}
                                        onDayTripleClick={(date) => { setSelectedDate(date); setView('day'); }}
                                        selectedDate={selectedDate}
                                        searchQuery={searchQuery}
                                    />
                                ) : (
                                    <DayView 
                                        key="day" 
                                        date={selectedDate} 
                                        entry={getEntry(selectedDate)} 
                                        calendarName={calendars.find(c => c.id === activeCalendarId)?.name}
                                        calendarColorIndex={calendars.find(c => c.id === activeCalendarId)?.colorIndex}
                                        theme={theme} 
                                        onChange={(text) => handleEntryChange(format(selectedDate, 'yyyy-MM-dd'), text)}
                                        onBack={() => setView(isMobile ? 'week' : 'month')}
                                        searchQuery={searchQuery}
                                    />
                                )}
                            </AnimatePresence>
                        </main>
                    </div>
                </div>
            );
        }

        // --- Sub Components ---
        function SidebarItem({ icon, label, active, theme, onClick }) {
            return (
                <button onClick={onClick} className={`w-full flex items-center gap-3 px-3 py-2 rounded-lg text-sm font-medium mb-0.5 ${active ? `${theme.sidebarActive} text-gray-900` : `${theme.sidebarText} hover:bg-gray-100`}`}>
                    {icon}<span>{label}</span>
                </button>
            );
        }

        function CalendarListItem({ calendar, isActive, isVisible, theme, onClick, onToggleVisibility, onRename, onChangeColor, onDelete }) {
            const [isEditing, setIsEditing] = useState(false);
            const [editName, setEditName] = useState(calendar.name);
            const [showColorPicker, setShowColorPicker] = useState(false);
            const color = CALENDAR_COLORS[calendar.colorIndex || 0];
            return (
                <div onClick={onClick} className={`group relative flex items-center justify-between px-3 py-1.5 rounded-lg cursor-pointer transition-all text-sm ${isActive ? 'bg-gray-100' : `hover:bg-gray-50`}`}>
                    <div className="flex items-center gap-3 flex-1 overflow-hidden">
                        <div className="w-2.5 h-2.5 rounded-sm flex-shrink-0 relative" style={{ backgroundColor: color.code }} onClick={(e) => { e.stopPropagation(); setShowColorPicker(!showColorPicker); }} />
                        {showColorPicker && (
                            <div className="absolute top-6 left-0 z-50 p-2 bg-white rounded shadow-xl border grid grid-cols-4 gap-1 w-[120px]" onClick={e=>e.stopPropagation()}>
                                {CALENDAR_COLORS.map((c, idx) => (
                                    <div key={idx} className="w-5 h-5 rounded-full cursor-pointer hover:scale-110" style={{ backgroundColor: c.code }} onClick={() => { onChangeColor(idx); setShowColorPicker(false); }} />
                                ))}
                            </div>
                        )}
                        {isEditing ? (
                            <input value={editName} onChange={e => setEditName(e.target.value)} onClick={e => e.stopPropagation()} onBlur={()=>{ onRename(editName); setIsEditing(false); }} className="bg-transparent border-b border-gray-300 w-full outline-none text-xs" autoFocus />
                        ) : (
                            <span className={`truncate flex-1 font-medium ${!isVisible && !isActive ? 'opacity-50 line-through' : ''} ${color.value}`}>{calendar.name}</span>
                        )}
                    </div>
                    <div className="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                         <button onClick={(e) => { e.stopPropagation(); onToggleVisibility(); }} className={`p-0.5 rounded hover:bg-gray-200 text-gray-500`}> {isVisible ? <Eye size={12} /> : <EyeOff size={12} />} </button>
                         <button onClick={(e) => { e.stopPropagation(); setIsEditing(true); }} className="p-0.5 hover:bg-gray-200 rounded text-gray-500"><Edit2 size={12} /></button>
                         <button onClick={(e) => { e.stopPropagation(); onDelete(); }} className="p-0.5 hover:bg-red-100 hover:text-red-500 rounded text-gray-500"><Trash2 size={12} /></button>
                    </div>
                </div>
            );
        }

        function HighlightedText({ text, highlight }) {
            if (!highlight?.trim()) return <span>{text}</span>;
            const parts = text.split(new RegExp(`(${highlight})`, 'gi'));
            return <span>{parts.map((part, i) => part.toLowerCase() === highlight.toLowerCase() ? <mark key={i} className="highlight rounded-sm px-0.5">{part}</mark> : <span key={i}>{part}</span>)}</span>;
        }

        // Unified Calendar View (Month & Week)
        function CalendarView({ viewType, currentDate, entries, entryColors, calendars, activeCalendarId, visibleCalendarIds, theme, onEntryChange, onColorChange, onDayClick, onDayTripleClick, selectedDate, searchQuery }) {
            const isMonth = viewType === 'month';
            let days;
            
            if (isMonth) {
                const monthStart = startOfMonth(currentDate);
                days = eachDayOfInterval({ start: startOfWeek(monthStart, { weekStartsOn: 0 }), end: endOfWeek(endOfMonth(currentDate), { weekStartsOn: 0 }) });
            } else {
                // Week view logic
                days = eachDayOfInterval({ start: startOfWeek(currentDate, { weekStartsOn: 0 }), end: endOfWeek(currentDate, { weekStartsOn: 0 }) });
            }

            const [bgPicker, setBgPicker] = useState(null);
            const clickRef = useRef({ count: 0, lastTime: 0, id: null });

            return (
                <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} className={`flex flex-col h-full ${theme.bg}`}>
                    <div className={`grid grid-cols-7 border-b ${theme.border}`}>
                        {['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'].map(w => <div key={w} className={`px-4 py-2 text-xs font-semibold ${theme.subText} text-center`}>{w}</div>)}
                    </div>
                    {/* Grid Layout: Month=5 rows, Week=1 row (full height) */}
                    <div className={`flex-1 grid grid-cols-7 ${isMonth ? 'grid-rows-5 md:grid-rows-5' : 'grid-rows-1'} overflow-y-auto`}>
                        {days.map((day, i) => {
                            const dateStr = format(day, 'yyyy-MM-dd');
                            const isCurrent = isSameMonth(day, currentDate);
                            const colorIndex = entryColors[activeCalendarId]?.[dateStr] || 0;
                            const bgColorClass = ENTRY_BG_COLORS[colorIndex]?.class || '';
                            const txt = entries[activeCalendarId]?.[dateStr] || '';
                            
                            // In week view, show all days clearly. In month view, fade out other months.
                            const opacityClass = (isMonth && !isCurrent) ? 'bg-opacity-50 opacity-50' : '';

                            return (
                                <div key={dateStr}
                                    onClick={(e) => {
                                        e.stopPropagation();
                                        const now = Date.now();
                                        if (clickRef.current.id === dateStr && (now - clickRef.current.lastTime) < 400) clickRef.current.count++; else clickRef.current = { count: 1, id: dateStr, lastTime: now };
                                        onDayClick(day);
                                        if (clickRef.current.count >= 3) onDayTripleClick(day);
                                    }}
                                    className={`
                                        relative flex flex-col border-b border-r ${theme.border} 
                                        ${bgColorClass} ${opacityClass} 
                                        ${isSameDay(day, selectedDate) ? 'ring-inset ring-2 ring-indigo-400' : ''} 
                                        group transition-colors
                                    `}
                                >
                                    <div className="flex justify-between p-1">
                                        <span className={`text-xs font-medium ${isToday(day) ? 'bg-gray-900 text-white w-6 h-6 flex items-center justify-center rounded-full' : theme.text}`}>{format(day, "d")}</span>
                                        <button className="opacity-0 group-hover:opacity-100 p-1 text-gray-400 hover:text-gray-900" onClick={(e) => { e.stopPropagation(); const r = e.currentTarget.getBoundingClientRect(); setBgPicker({ dateStr, top: r.bottom, left: r.right - 120 }); }}><Palette size={12}/></button>
                                    </div>
                                    <textarea 
                                        value={txt} 
                                        onChange={(e) => onEntryChange(dateStr, e.target.value)} 
                                        className={`flex-1 w-full text-xs md:text-sm resize-none bg-transparent outline-none px-2 pb-2 leading-relaxed ${theme.text}`} 
                                        placeholder={isMonth ? "" : "Write..."}
                                    />
                                </div>
                            );
                        })}
                    </div>
                    {bgPicker && (
                        <>
                            <div className="fixed inset-0 z-40" onClick={() => setBgPicker(null)} />
                            <div className="fixed z-50 p-2 rounded-lg shadow-xl border bg-white grid grid-cols-5 gap-1" style={{ top: bgPicker.top, left: bgPicker.left }}>
                                {ENTRY_BG_COLORS.map((c, idx) => <div key={idx} className={`w-6 h-6 rounded-full cursor-pointer border ${c.class || 'bg-white'}`} onClick={() => { onColorChange(bgPicker.dateStr, idx); setBgPicker(null); }} />)}
                            </div>
                        </>
                    )}
                </motion.div>
            );
        }

        function DayView({ date, entry, calendarName, calendarColorIndex, theme, onChange, onBack }) {
            return (
                <motion.div initial={{ opacity: 0, scale: 0.95 }} animate={{ opacity: 1, scale: 1 }} className="flex flex-col h-full max-w-3xl mx-auto p-4 md:p-8 w-full">
                    <button onClick={onBack} className="md:hidden mb-2 text-sm text-gray-500 flex items-center gap-1"><ChevronLeft size={16}/> Back</button>
                    <div className={`rounded-2xl shadow-xl border ${theme.border} flex flex-col h-full overflow-hidden ${theme.card}`}>
                        <div className={`px-6 py-4 border-b ${theme.border} bg-opacity-50`}>
                            <h2 className={`text-2xl font-bold ${theme.text}`}>{format(date, 'd MMMM yyyy')}</h2>
                            <p className={`text-xs uppercase tracking-wide ${CALENDAR_COLORS[calendarColorIndex || 0].value}`}>{format(date, 'EEEE')}  {calendarName}</p>
                        </div>
                        <textarea value={entry} onChange={(e) => onChange(e.target.value)} placeholder="Write here..." className={`flex-1 w-full p-6 text-lg leading-relaxed resize-none outline-none bg-transparent ${theme.text} ${CALENDAR_COLORS[calendarColorIndex || 0].value}`} autoFocus />
                    </div>
                </motion.div>
            );
        }

        function DatePicker({ currentDate, onChange, theme }) {
            const months = Array.from({ length: 12 }, (_, i) => i);
            return (
                <div className={`p-4 rounded-xl shadow-2xl border ${theme.border} ${theme.card} w-64`}>
                    <div className="grid grid-cols-3 gap-2">
                        {months.map(m => (
                            <button key={m} onClick={() => onChange(setMonth(currentDate, m))} className={`py-2 rounded text-sm hover:bg-gray-50 ${getMonth(currentDate) === m ? 'bg-gray-900 text-white' : theme.text}`}>{format(new Date(2000, m, 1), 'MMM')}</button>
                        ))}
                    </div>
                </div>
            );
        }

        function ThemeBtn({ mode, current, set, icon }) {
            return <button onClick={() => set(mode)} className={`p-2 transition-colors ${current === mode ? 'bg-gray-100 text-gray-900' : 'text-gray-400 hover:text-gray-600'}`}>{icon}</button>;
        }

        const root = createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>
</body>
</html>
